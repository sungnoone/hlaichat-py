# HLAIChat 聊天功能測試指南

本文件說明如何測試 HLAIChat 平台的聊天功能，包含 webhook trigger workflow 的仿 ChatGPT 聊天介面。

## 功能概述

HLAIChat 平台支援多種聊天連結類型，為未來的 Flowise 整合做好準備：

### 聊天連結類型

| 類型名稱 | 說明 | 測試方式 |
|---------|------|---------|
| `n8n_host_chat` | n8n Host Chat | 直接開啟 n8n 提供的完整聊天網頁 |
| `n8n_embedded_chat` | n8n Embedded Chat | 查看和複製嵌入代碼 |
| `n8n_webhook` | n8n Webhook | 使用仿 ChatGPT 介面進行對話 |
| `flowise_chat` | Flowise Chat | 預留類型（未來功能） |

## 測試前準備

### 1. 環境設定

確保以下服務正常運行：
- PostgreSQL 資料庫
- 後端 FastAPI 服務
- 前端 Vue.js 應用程式

### 2. 資料庫遷移

執行所有必要的資料庫遷移腳本：

```bash
# 基本資料庫結構
python migrate_db.py

# 聊天相關表格
python migrate_chat_tables.py

# 聊天連結類型更新（重要）
python migrate_chat_link_types.py
```

### 3. 類型系統驗證

執行類型系統測試腳本：

```bash
python test_chat_link_types.py
```

預期結果：
- ✅ 所有聊天連結類型都符合新的命名規範
- ✅ webhook_url 和 credential_id 欄位存在
- ✅ API 類型驗證邏輯正確
- ✅ 舊格式類型被正確拒絕

## 測試步驟

### 1. 管理員功能測試

#### 1.1 聊天連結管理

1. **登入管理員帳號**
   - 使用者名稱：admin
   - 密碼：admin

2. **新增 n8n Host Chat 連結**
   - 進入「聊天連結管理」頁面
   - 點擊「新增連結」
   - 選擇類型：n8n Host Chat
   - 填入 n8n Host Chat URL
   - 選擇可使用的群組
   - 儲存並驗證

3. **新增 n8n Embedded Chat 連結**
   - 選擇類型：n8n Embedded Chat
   - 填入嵌入代碼
   - 選擇可使用的群組
   - 儲存並驗證

4. **新增 n8n Webhook 連結**
   - 選擇類型：n8n Webhook
   - 填入 webhook URL
   - 選擇 API 憑證
   - 選擇可使用的群組
   - 儲存並驗證

#### 1.2 憑證管理

1. **新增 API 憑證**
   - 進入「憑證管理」頁面
   - 新增憑證，設定名稱和 API Key
   - **✅ 已驗證**：憑證可在聊天連結中選擇

2. **憑證選擇功能測試**
   - 進入「聊天連結管理」頁面
   - 點擊「新增連結」
   - 選擇「n8n Webhook」類型
   - **✅ 已驗證**：「選擇 API Key 憑證」下拉選單正確顯示預設憑證
   - **✅ 已驗證**：可以成功選擇和儲存憑證設定

### 2. 使用者功能測試

#### 2.1 聊天介面測試（n8n Webhook 類型）

1. **登入一般使用者**
   - 使用有權限的使用者帳號登入

2. **進入聊天介面**
   - 點擊導航選單中的「聊天對話」
   - 驗證可以看到有權限的 webhook 類型聊天連結

3. **建立新對話**
   - 選擇一個 webhook 類型的聊天連結
   - 建立新的聊天會話
   - 驗證會話標題自動生成

4. **發送訊息**
   - 在聊天介面中輸入訊息
   - 點擊發送
   - 驗證訊息立即顯示
   - 驗證載入狀態顯示
   - 驗證 AI 回應接收

5. **會話管理**
   - 測試會話列表顯示
   - 測試切換不同會話
   - 測試會話標題編輯
   - 測試會話刪除

## Webhook 參數規範

每次向 n8n webhook 發送的 POST 請求包含以下參數：

```json
{
  "user_id": "當前登入使用者ID",
  "session_id": "對話 session 唯一識別碼",
  "api_key": "選定的 API Key",
  "message": "使用者輸入的訊息內容",
  "sequence": "訊息序號(由後端架構維護)",
  "timestamp": "台北時間戳記",
  "user_name": "使用者姓名"
}
```

## 錯誤處理測試

### 1. 網路錯誤

- 測試 webhook 無法連接的情況
- 驗證錯誤訊息顯示
- 驗證使用者訊息仍被保存

### 2. 超時錯誤

- 測試 webhook 回應超時（預設 5 分鐘，可透過環境變數調整）
- 驗證超時錯誤處理
- 驗證處理時間記錄
- 測試不同逾時設定值的效果
- 驗證前後端逾時設定的一致性

### 3. HTTP 錯誤

- 測試 webhook 返回 4xx/5xx 錯誤
- 驗證錯誤狀態碼處理
- 驗證錯誤訊息顯示

### 4. Webhook 回應格式錯誤

- **JSON 解析錯誤測試**：測試 n8n 回應非 JSON 格式內容的處理
- **回應欄位測試**：驗證系統能正確解析不同的回應欄位格式
  - 測試 `output` 欄位（n8n "Respond to Webhook" 節點的標準格式）
  - 測試 `message` 欄位（其他系統可能使用的格式）
  - 測試 `text` 和 `content` 欄位（備用格式）
- **空回應測試**：測試 webhook 回應為空或無效時的處理
- **特殊字符測試**：測試回應包含特殊字符、換行符、中文字符的處理
- **大型回應測試**：測試處理大量文字回應的能力

## 資料庫驗證

### 1. 聊天會話表 (chat_sessions)

驗證以下欄位正確儲存：
- session_id（唯一識別碼）
- user_id（使用者ID）
- chat_link_id（聊天連結ID）
- title（會話標題）
- is_active（是否活躍）
- created_at、updated_at（時間戳記）

### 2. 聊天訊息表 (chat_messages)

驗證以下欄位正確儲存：
- session_id（會話ID）
- sequence（訊息序號）
- message_type（user 或 assistant）
- content（訊息內容）
- webhook_response（webhook 回應，JSON 格式）
- processing_time（處理時間，毫秒）
- created_at（建立時間）

### 3. 聊天連結表 (chat_links)

驗證類型系統正確性：
- link_type 欄位只包含有效類型
- webhook_url 和 credential_id 欄位存在
- 外鍵關聯正確

## 效能測試

### 1. 並發測試

- 測試多個使用者同時使用聊天功能
- 驗證會話隔離正確性
- 驗證資料庫連線池處理

### 2. 大量訊息測試

- 測試長對話的處理
- 驗證訊息序號正確性
- 驗證分頁載入效能

## 安全性測試

### 1. 權限驗證

- 測試使用者只能存取有權限的聊天連結
- 測試會話隔離（使用者A無法存取使用者B的會話）
- 測試 API Key 安全傳遞

### 2. 輸入驗證

- 測試惡意輸入處理
- 測試超長訊息處理
- 測試特殊字符處理

## 逾時設定測試

### 1. 環境變數設定測試

驗證逾時參數正確載入：
- 檢查 `.env` 檔案包含所有逾時參數
- 驗證後端正確讀取 `CHAT_WEBHOOK_TIMEOUT`、`CHAT_REQUEST_TIMEOUT`、`CHAT_CONNECTION_TIMEOUT`
- 驗證前端正確讀取 `VITE_CHAT_TIMEOUT`
- **編碼測試**：驗證 `.env` 檔案中文註解正確顯示，無亂碼問題
- **檔案完整性測試**：確認 `.env` 檔案包含所有必要的環境變數參數

### 2. 逾時行為測試

測試不同逾時情境：
- **短逾時測試**：設定較短的逾時時間（如 10 秒），驗證逾時錯誤正確觸發
- **長逾時測試**：設定較長的逾時時間（如 10 分鐘），驗證長時間處理的 workflow 能正常完成
- **前後端逾時一致性**：確保前端逾時時間略大於後端，避免前端先逾時

### 3. 逾時錯誤處理測試

驗證逾時錯誤的處理：
- 使用者訊息仍被正確保存
- 系統顯示適當的錯誤訊息
- 處理時間被正確記錄
- 會話狀態保持正常

### 4. 動態逾時調整測試

測試逾時設定的動態調整：
- 修改 `.env` 檔案中的逾時參數
- 重新啟動服務
- 驗證新的逾時設定生效
- 測試不同複雜度的 n8n workflow

## 類型系統測試

### 1. 遷移測試

執行遷移腳本並驗證：
```bash
python migrate_chat_link_types.py
```

預期結果：
- 舊類型成功更新為新類型
- 資料完整性保持
- 無資料遺失

### 2. API 驗證測試

測試 API 端點的類型驗證：
- 新增聊天連結時只接受有效類型
- 舊類型被正確拒絕
- 錯誤訊息清晰明確

### 3. 前端顯示測試

驗證前端正確顯示：
- 類型選項正確
- 類型標籤和顏色正確
- 操作選單根據類型顯示

## 故障排除

### 常見問題

1. **聊天連結類型錯誤**
   - 執行 `python migrate_chat_link_types.py`
   - 檢查資料庫中的 link_type 欄位

2. **webhook 連接失敗**
   - 檢查 n8n 服務是否運行
   - 驗證 webhook URL 正確性
   - 檢查 API Key 設定

3. **會話無法建立**
   - 確認聊天連結類型為 n8n_webhook
   - 檢查使用者群組權限
   - 驗證資料庫連線

4. **前端顯示異常**
   - 檢查瀏覽器控制台錯誤
   - 驗證 API 回應格式
   - 確認前端依賴套件完整

5. **環境變數編碼問題**
   - 檢查 `.env` 檔案是否使用 UTF-8 編碼
   - 執行 `.\setup_env.ps1` 重新建立檔案
   - 使用 `Get-Content .env -Encoding UTF8` 驗證中文顯示正常

## 測試完成檢查清單

- [x] 資料庫遷移成功
- [x] 類型系統測試通過
- [x] 管理員可以管理所有類型的聊天連結
- [x] **憑證選擇功能正常**：新增 webhook 類型連結時可選擇預設憑證
- [x] **逾時設定優化完成**：所有逾時參數已移至環境變數統一管理
- [x] **環境變數編碼修復**：.env 檔案中文亂碼問題已解決，使用 UTF-8 編碼
- [x] **Webhook 回應解析修復**：n8n "Respond to Webhook" 節點回應格式解析問題已解決
- [x] 使用者可以使用 webhook 類型聊天介面
- [x] 聊天會話和訊息正確儲存
- [x] Webhook 參數正確傳遞
- [x] 錯誤處理機制正常（包含逾時錯誤處理）
- [x] 逾時設定測試通過
- [ ] 權限控制有效
- [ ] 效能表現良好
- [ ] 前端介面響應正常

## 未來擴展測試

當 Flowise 整合完成後，需要測試：
- [ ] flowise_chat 類型的聊天連結
- [ ] Flowise 特定的參數傳遞
- [ ] 多平台聊天連結共存
- [ ] 類型系統的擴展性 