#開發指引文件

## 文件搜尋

在需要查詢 FastAPI、Python、SQLAlchemy、Google 等相關文件時，請務必使用 Context7 以取得最新的、版本相關的文件資訊。

### FastAPI 文件搜索
當需要查詢 FastAPI 文件時，**搜尋 FastAPI 的穩定版本文件**。在你的提問中，明確包含 `use context7` 並指明需要 FastAPI 的穩定版文件。例如：
```
use context7 搜尋 FastAPI 穩定版技術文檔
```

### Python 文件搜索
當需要查詢 Python 文件時，**搜尋 Python 的最新版本文件**。在你的提問中，明確包含 `use context7` 並指明需要 Python 的最新文件。例如：
```
use context7 搜尋 Python 最新版技術文檔
```

### SQLAlchemy 文件搜索
當需要查詢 SQLAlchemy 文件時，**搜尋 SQLAlchemy 的最新版本文件**。在你的提問中，明確包含 `use context7` 並指明需要 SQLAlchemy 的最新文件。例如：
```
use context7 搜尋 SQLAlchemy 最新版技術文檔
```

### 命令列指令適用性
開發及部署環境均為 Windows 環境，應注意指令必須在 PowerShell 可執行。

## 專案注意事項(務必遵守)

- **以本地時間(台北時間)為準**: 專案及資料庫一律都以本地時間(台北時間)為開發、記錄及操作標準。
- **架構保持簡潔易懂勿過於複雜**: 架構應保持簡潔易懂容易維護的大原則，勿有重複性質的資料夾。
- **不分開發或正式環境，不須要搞複雜**
- **移除冗餘程式碼及檔案**: 每個功能開發或修正除錯完成，測試沒問題後，應把專案掃描一遍，在確保專案執行正確性及符合目的需求前提下，移除冗餘的程式碼、檔案、文件及函數。
- **基礎簡單的網站安全性即可**: 不使用過於複雜高安全性機制。簡單容易實作，程式碼容易維護，不容易出錯為原則。後期有需要再增加更高的安全機制。

## 重要文件位置(務必遵守)

- **環境變數檔**: 專案所有環境參數變數配置，統一保存在 `.env`，單純化集中化參數的存取位置。不要多開檔案，不要寫死在程式碼內。參數儲存都是明文不加密。
- **讀我檔案**: `README.md`，紀錄專案目標、特殊需求、架構和功能，若有調整應隨時更新。開發中斷或日後重新維護，讀取需求，勿偏離專案核心需求及功能。
- **修改歷程**: `CHANGELOG.md` 專案每次修正及除錯歷程記錄，統一集中紀錄於此。

## 技術堆疊偏好

在本專案中，我們優先使用以下技術堆疊進行開發：

- **後端框架**: **FastAPI**。請優先使用最新穩定版本的 FastAPI 來建立 API 路由和處理請求。
- **ORM**: **SQLAlchemy**。使用 SQLAlchemy 進行資料庫操作和模型定義。
- **資料驗證**: **Pydantic**。使用 Pydantic 進行資料驗證和模型定義。
- **前端框架**: **Vue.js 3**。使用 Vue.js 3 作為前端框架，提供響應式數據和組件化開發。
- **前端樣式及 UI 元件**:
	- **根據功能拆分程式碼檔案，保持結構清晰；**: 請每個功能介面需獨立一個 HTML 檔。
	- **集中資料夾存放自訂CSS檔**: CSS檔內應完整繁體中文註解其作用。
	- **Vuetify**: 基於 Vue.js 的完整 UI 框架，提供豐富的現成組件和響應式設計，完全免費開源。
	- **Vue Router**: 官方路由管理器，用於創建單頁應用程式，完全免費開源。
	- **Font Awesome**: 大量免費圖標庫，完全免費開源。
	- **頁面所需圖片可從 Unsplash、Pexels 取得**:
	- **構建工具**: 
		-**Vite**:使用 Vite 作為前端構建工具，提供更快的開發體驗和熱更新。
- **前後端整合**: 使用 FastAPI 提供 RESTful API，Vue.js 透過 Axios 調用 API。可以使用 FastAPI 的靜態文件功能來託管 Vue.js 構建後的文件。
- **程式語言**: **Python 3.9+** 用於後端，**JavaScript** 用於前端。使用 JavaScript 可以降低學習曲線並簡化開發過程。
- **套件管理器**: 請使用 **pip** 和 **requirements.txt** 管理後端套件依賴，使用 **npm** 管理前端套件依賴。



## 程式碼風格和模式

請遵循以下程式碼風格和常用模式：

- **類別命名**: 使用 **PascalCase** 命名 (例如，`UserModel`, `AuthService`)。
- **函數命名**: 函數應使用 **snake_case** 命名 (例如，`get_user`, `authenticate_user`)。
- **變數命名**: 變數應使用 **snake_case** 命名 (例如，`user_groups`, `chat_links`)。常數可以使用 **UPPER_SNAKE_CASE** (例如，`MAX_USERS`)。
- **型別註解**: 盡可能使用 Python 型別註解增加程式碼可讀性。
- **文件字串**: 使用文件字串 (docstrings) 描述函數、類別和模組的用途和使用方式。
- **錯誤處理**: 適當使用 try-except 處理可能的例外情況，並提供有意義的錯誤訊息。
- **程式碼應有繁體中文說明註解**，確保日後容易維護容易懂。


## 應用核心邏輯

本專案旨在創建一個管理平台，管理各個不同用途目的 AI 聊天流程對話網址，並依使用者所屬群組，分配可以使用的聊天網址。具有以下特點：

### AD 網域驗證登入

管理者在管理介面內，搜尋 AD 使用者，並勾選加入選定的平台群組。AD 使用者，須經管理者配對適當權限的群組後，方能登入使用。

- **AD 網域參數配置** (一律明文存於環境變數檔內):
  - 網域名稱: hanlin.com.tw
  - 網域主要 DC (有多個): 192.168.1.6, 192.168.1.5, 192.168.5.5
  - 網域綁定查詢帳號密碼: 由平台管理介面輸入後儲存
- **AD 網域連線驗證**:
  - 網站啟動連線: 網站服務啟動後，若變數檔存在且檔案內有設定 AD 連線配置參數，則載入配置參數並嘗試連線，若環境變數檔內沒有設定 AD 連線配置參數，則不進行網域連線，管理者介面須能讓管理者修改儲存及測試網域連線，並即時了解目前網域連線狀態。

### 平台內建帳號登入

管理者在管理介面內，可增刪修平台使用者帳號、密碼及相關屬性。

- 使用者儲存: 登入名稱、登入密碼、姓名、電話、單位、郵件、啟用或停用、備註、建立日期等資訊
- 預設管理者: admin，密碼 admin
- 密碼管理: 平台使用者可以變更自己的密碼。管理者可變更所有人的密碼，包含自己的。

### 平台群組管理

管理者可增刪修平台群組，群組可設定平台權限，例如可登入、可管理、可使用等複合權限。admins 群組有網站最大權限。

### AI 聊天流程對話網址管理

主要由 n8n 或 Flowise 產生，可能是獨立的 Hosted Chat 完整網址，或是需要自訂網頁嵌入的 Embedded Chat Code。透過管理介面，指派那些群組可以使用那些連結。

### 資料庫

使用 PostgreSQL 資料庫，連線字串: `postgres://postgres:hl69382361@192.168.1.221:5432/hlaichat-py`。

### 操作紀錄

使用者登入及各項操作應留存紀錄，並提供管理者查詢分析。

## 安全性注意事項

為避免初期增加除錯時間，安全性機制保持最基本簡單：

- **簡單會話認證**: 使用基本的 Cookie-based 會話認證，避免複雜的 JWT 實作和加密機制。
- **基本密碼存儲**: 使用明文方式存儲密碼，不需加密或雜湊處理，日後有需要再增加安全機制。
- **最小輸入驗證**: 使用 Pydantic 進行最基本的輸入型別檢查，避免複雜的驗證規則。
- **關閉 CORS 限制**: 初期可完全關閉 CORS 限制或設定為允許所有來源，以方便前後端開發和測試。
- **簡易權限模型**: 使用簡單的布林值標記 (如 is_admin) 進行權限控制，避免複雜的角色權限矩陣。
- **明文環境變數**: 所有配置參數使用明文存儲於 .env 檔案中，無需加密。
- **單一授權層**: 簡化授權檢查層級，集中在一個地方處理，避免多重權限檢查。

請在開發過程中，優先考慮實現上述核心功能，並確保程式碼的可讀性和可維護性。後期可根據需要增加更高的安全機制。