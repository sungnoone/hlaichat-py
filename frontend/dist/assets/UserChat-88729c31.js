import{_ as O,u as Q,x as Y,r as h,o as Z,a as l,b as u,c as K,w as o,e as s,g as c,t as y,h as v,f as r,d as L,j as le,y as X,F as ee,i as te,s as re,p as A,l as se,n as G,z as J,m as de}from"./index-a1ba2a77.js";const ce={name:"EmbeddedChatInterface",setup(){const f=Q(),e=Y(),m=h(null),t=()=>{f.push("/user-dashboard")},b=async()=>{const p=e.query.linkId;if(!p){f.push("/user-dashboard");return}try{const d=await L.get(`/api/chat-links/${p}`);if(d.data.success){if(m.value=d.data.data,m.value.link_type!=="n8n_embedded_chat"){console.error("此連結不是 embedded 類型"),f.push("/user-dashboard");return}}else throw new Error("無法獲取聊天連結資訊")}catch(d){console.error("獲取聊天連結失敗:",d),f.push("/user-dashboard")}};return Z(()=>{b()}),{chatLink:m,goBack:t}}},ue={key:0,class:"embed-container"},_e=["innerHTML"],me={key:1,class:"error-container"},ve={key:2,class:"loading-container"};function fe(f,e,m,t,b,p){const d=l("v-icon"),_=l("v-btn"),k=l("v-app-bar-title"),C=l("v-app-bar"),x=l("v-progress-circular"),S=l("v-main"),w=l("v-container");return u(),K(w,{fluid:"",class:"embedded-chat-container pa-0 fill-height"},{default:o(()=>[s(C,{color:"primary",density:"compact",class:"chat-header"},{default:o(()=>[s(_,{icon:"",onClick:t.goBack,class:"mr-2"},{default:o(()=>[s(d,null,{default:o(()=>e[0]||(e[0]=[c("mdi-arrow-left")])),_:1})]),_:1},8,["onClick"]),s(k,null,{default:o(()=>{var T;return[c(y(((T=t.chatLink)==null?void 0:T.name)||"聊天機器人"),1)]}),_:1})]),_:1}),s(S,{class:"embedded-main"},{default:o(()=>[t.chatLink&&t.chatLink.embed_code?(u(),v("div",ue,[r("div",{innerHTML:t.chatLink.embed_code,class:"embed-content"},null,8,_e)])):t.chatLink&&!t.chatLink.embed_code?(u(),v("div",me,[s(d,{size:"64",color:"error",class:"mb-4"},{default:o(()=>e[1]||(e[1]=[c("mdi-alert-circle")])),_:1}),e[2]||(e[2]=r("h3",{class:"text-h5 mb-2"},"嵌入代碼未設定",-1)),e[3]||(e[3]=r("p",{class:"text-body-1 text-grey"},"此聊天連結尚未設定嵌入代碼，請聯絡管理員。",-1))])):(u(),v("div",ve,[s(x,{indeterminate:"",color:"primary",size:"64"}),e[4]||(e[4]=r("p",{class:"mt-4 text-h6"},"載入中...",-1))]))]),_:1})]),_:1})}const pe=O(ce,[["render",fe],["__scopeId","data-v-3bae5c0e"]]);const be={name:"WebhookChatInterface",setup(){const f=Q(),e=Y(),m=h(null),t=h([]),b=h(null),p=h(null),d=h([]),_=h(""),k=h(!1),C=h(!1),x=h(null),S=h(300),w=h(!1),T=200,z=600,M=()=>{const a=localStorage.getItem("webhook-chat-sidebar-width");if(a){const n=parseInt(a);n>=T&&n<=z&&(S.value=n)}},F=()=>{localStorage.setItem("webhook-chat-sidebar-width",S.value.toString())},g=le({show:!1,sessionId:null,title:""}),P=a=>new Date(a).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}),E=a=>{const n=new Date(a),ie=Math.abs(new Date-n),H=Math.ceil(ie/(1e3*60*60*24));return H===1?"今天":H===2?"昨天":H<=7?`${H} 天前`:n.toLocaleDateString("zh-TW")},B=()=>{J(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)})},R=a=>{w.value=!0,document.addEventListener("mousemove",U),document.addEventListener("mouseup",W),a.preventDefault()},U=a=>{if(!w.value)return;const n=a.clientX;n>=T&&n<=z&&(S.value=n)},W=()=>{w.value=!1,document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",W),F()},N=()=>{f.push("/user-dashboard")},j=async()=>{const a=e.query.linkId;if(!a){f.push("/user-dashboard");return}try{const n=await L.get(`/api/chat-links/${a}`);if(n.data.success){if(m.value=n.data.data,m.value.link_type!=="n8n_webhook"){console.error("此連結不是 webhook 類型"),f.push("/user-dashboard");return}await I()}else throw new Error("無法獲取聊天連結資訊")}catch(n){console.error("獲取聊天連結失敗:",n),f.push("/user-dashboard")}},I=async()=>{try{const a=await L.get("/api/chat/sessions");a.data.sessions&&(t.value=a.data.sessions.filter(n=>n.chat_link_id===m.value.id))}catch(a){console.error("載入會話列表失敗:",a)}},q=async()=>{if(m.value)try{const a=await L.post("/api/chat/sessions",{chat_link_id:m.value.id,title:null});a.data&&(await I(),await V(a.data.session_id))}catch(a){console.error("建立會話失敗:",a)}},V=async a=>{try{p.value=a;const n=await L.get(`/api/chat/sessions/${a}`);n.data&&(b.value=n.data,d.value=n.data.messages||[],await J(),B())}catch(n){console.error("載入會話詳情失敗:",n)}},i=async()=>{if(!_.value.trim()||!p.value||k.value)return;const a=_.value.trim();_.value="",k.value=!0;try{const n=await L.post(`/api/chat/sessions/${p.value}/messages`,{session_id:p.value,content:a});n.data.success?(d.value.push(n.data.user_message),d.value.push(n.data.ai_message)):(d.value.push(n.data.user_message),n.data.ai_message&&d.value.push(n.data.ai_message)),await J(),B(),await I()}catch(n){console.error("發送訊息失敗:",n)}finally{k.value=!1}},D=a=>{g.sessionId=a.session_id,g.title=a.title,g.show=!0},oe=async()=>{try{await L.put(`/api/chat/sessions/${g.sessionId}`,{title:g.title}),await I(),b.value&&b.value.session_id===g.sessionId&&(b.value.title=g.title),g.show=!1}catch(a){console.error("更新會話標題失敗:",a)}},$=async a=>{if(confirm("確定要刪除這個對話嗎？此操作無法復原。"))try{await L.delete(`/api/chat/sessions/${a}`),await I(),p.value===a&&(p.value=null,b.value=null,d.value=[])}catch(n){console.error("刪除會話失敗:",n)}},ae=()=>{C.value=!0},ne=async()=>{p.value&&await $(p.value),C.value=!1};return Z(()=>{M(),j()}),{chatLink:m,sessions:t,currentSession:b,currentSessionId:p,messages:d,newMessage:_,isLoading:k,clearDialog:C,messagesContainer:x,editTitleDialog:g,sidebarWidth:S,isResizing:w,formatTime:P,formatDate:E,startResize:R,goBack:N,createNewSession:q,selectSession:V,sendMessage:i,editSessionTitle:D,updateSessionTitle:oe,deleteSession:$,clearCurrentSession:ae,confirmClearSession:ne}}},he={class:"webhook-chat-container"},ge={class:"main-content"},ye={class:"resizable-layout"},ke={class:"sidebar-header"},we={class:"session-list-container"},Ce={class:"messages-container",ref:"messagesContainer"},xe={class:"messages-content"},Se={key:0,class:"welcome-message text-center py-8"},Ie={class:"text-h5 mb-2"},Le={class:"text-body-1 text-grey"},Te={key:1,class:"messages-list"},ze={key:0,class:"user-message d-flex justify-end"},De={class:"message-bubble user-bubble"},We={class:"message-content"},Ve={class:"message-time"},Me={key:1,class:"ai-message d-flex justify-start"},Ee={class:"message-bubble ai-bubble"},Be={class:"message-content"},Re={class:"message-time"},Ue={key:0,class:"processing-time"},Ne={key:0,class:"ai-message d-flex justify-start"},je={class:"input-container"};function qe(f,e,m,t,b,p){var q,V;const d=l("v-icon"),_=l("v-btn"),k=l("v-app-bar-title"),C=l("v-spacer"),x=l("v-app-bar"),S=l("v-divider"),w=l("v-list-item-title"),T=l("v-list-item-subtitle"),z=l("v-list-item"),M=l("v-list"),F=l("v-menu"),g=l("v-avatar"),P=l("v-textarea"),E=l("v-col"),B=l("v-row"),R=l("v-card-title"),U=l("v-text-field"),W=l("v-card-text"),N=l("v-card-actions"),j=l("v-card"),I=l("v-dialog");return u(),v("div",he,[s(x,{color:"primary",density:"compact",class:"chat-header",app:""},{default:o(()=>[s(_,{icon:"",onClick:t.goBack,class:"mr-2"},{default:o(()=>[s(d,null,{default:o(()=>e[9]||(e[9]=[c("mdi-arrow-left")])),_:1})]),_:1},8,["onClick"]),s(k,null,{default:o(()=>{var i;return[c(y(((i=t.chatLink)==null?void 0:i.name)||"聊天機器人"),1)]}),_:1}),s(C),s(_,{icon:"",onClick:t.clearCurrentSession,disabled:!t.currentSession||t.messages.length===0},{default:o(()=>[s(d,null,{default:o(()=>e[10]||(e[10]=[c("mdi-delete-sweep")])),_:1})]),_:1},8,["onClick","disabled"])]),_:1}),r("div",ge,[r("div",ye,[r("div",{class:"chat-history-sidebar",style:X({width:t.sidebarWidth+"px"})},[r("div",ke,[e[12]||(e[12]=r("span",{class:"sidebar-title"},"對話記錄",-1)),s(_,{icon:"",size:"small",onClick:t.createNewSession,color:"primary",class:"new-chat-btn"},{default:o(()=>[s(d,null,{default:o(()=>e[11]||(e[11]=[c("mdi-plus")])),_:1})]),_:1},8,["onClick"])]),s(S),r("div",we,[s(M,{class:"session-list pa-0"},{default:o(()=>[(u(!0),v(ee,null,te(t.sessions,i=>(u(),K(z,{key:i.session_id,active:t.currentSessionId===i.session_id,onClick:D=>t.selectSession(i.session_id),class:"session-item"},{append:o(()=>[s(F,null,{activator:o(({props:D})=>[s(_,de({icon:"",size:"x-small",variant:"text",ref_for:!0},D,{onClick:e[0]||(e[0]=G(()=>{},["stop"]))}),{default:o(()=>[s(d,null,{default:o(()=>e[13]||(e[13]=[c("mdi-dots-vertical")])),_:1})]),_:2},1040)]),default:o(()=>[s(M,null,{default:o(()=>[s(z,{onClick:D=>t.editSessionTitle(i)},{default:o(()=>[s(w,null,{default:o(()=>e[14]||(e[14]=[c("重新命名")])),_:1})]),_:2},1032,["onClick"]),s(z,{onClick:D=>t.deleteSession(i.session_id)},{default:o(()=>[s(w,{class:"text-error"},{default:o(()=>e[15]||(e[15]=[c("刪除")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),default:o(()=>[s(w,{class:"text-truncate"},{default:o(()=>[c(y(i.title||"新對話"),1)]),_:2},1024),s(T,null,{default:o(()=>[c(y(t.formatDate(i.updated_at)),1)]),_:2},1024)]),_:2},1032,["active","onClick"]))),128))]),_:1})])],4),r("div",{class:re(["resizer",{resizing:t.isResizing}]),onMousedown:e[1]||(e[1]=(...i)=>t.startResize&&t.startResize(...i))},e[16]||(e[16]=[r("div",{class:"resizer-line"},null,-1)]),34),r("div",{class:"chat-area",style:X({width:"calc(100% - "+(t.sidebarWidth+4)+"px)"})},[r("div",Ce,[r("div",xe,[t.currentSession?(u(),v("div",Te,[(u(!0),v(ee,null,te(t.messages,i=>(u(),v("div",{key:i.id,class:"message-item mb-4"},[i.message_type==="user"?(u(),v("div",ze,[r("div",De,[r("div",We,y(i.content),1),r("div",Ve,y(t.formatTime(i.timestamp)),1)])])):(u(),v("div",Me,[s(g,{size:"32",color:"primary",class:"mr-3 mt-1"},{default:o(()=>[s(d,{color:"white"},{default:o(()=>e[18]||(e[18]=[c("mdi-robot")])),_:1})]),_:1}),r("div",Ee,[r("div",Be,y(i.content),1),r("div",Re,[c(y(t.formatTime(i.timestamp))+" ",1),i.processing_time?(u(),v("span",Ue," ("+y(i.processing_time)+"ms) ",1)):A("",!0)])])]))]))),128)),t.isLoading?(u(),v("div",Ne,[s(g,{size:"32",color:"primary",class:"mr-3 mt-1"},{default:o(()=>[s(d,{color:"white"},{default:o(()=>e[19]||(e[19]=[c("mdi-robot")])),_:1})]),_:1}),e[20]||(e[20]=r("div",{class:"message-bubble ai-bubble"},[r("div",{class:"typing-indicator"},[r("span"),r("span"),r("span")])],-1))])):A("",!0)])):(u(),v("div",Se,[s(d,{size:"64",color:"primary",class:"mb-4"},{default:o(()=>e[17]||(e[17]=[c("mdi-robot")])),_:1}),r("h3",Ie,y(((q=t.chatLink)==null?void 0:q.name)||"聊天機器人"),1),r("p",Le,y(((V=t.chatLink)==null?void 0:V.description)||"選擇或建立一個對話開始聊天"),1)]))])],512),t.currentSession?(u(),v("div",{key:0,class:"input-area-fixed",style:X({width:"calc(100% - "+(t.sidebarWidth+4)+"px)"})},[r("div",je,[s(B,{"no-gutters":"",align:"center"},{default:o(()=>[s(E,null,{default:o(()=>[s(P,{modelValue:t.newMessage,"onUpdate:modelValue":e[2]||(e[2]=i=>t.newMessage=i),placeholder:"輸入您的訊息...",variant:"outlined",density:"compact",rows:"1","auto-grow":"","max-rows":"4","hide-details":"",onKeydown:[se(G(t.sendMessage,["exact","prevent"]),["enter"]),e[3]||(e[3]=se(G(i=>t.newMessage+=`
`,["shift","exact"]),["enter"]))],disabled:t.isLoading,class:"message-input"},null,8,["modelValue","onKeydown","disabled"])]),_:1}),s(E,{cols:"auto",class:"ml-2"},{default:o(()=>[s(_,{icon:"",color:"primary",disabled:!t.newMessage.trim()||t.isLoading,onClick:t.sendMessage,size:"large"},{default:o(()=>[s(d,null,{default:o(()=>e[21]||(e[21]=[c("mdi-send")])),_:1})]),_:1},8,["disabled","onClick"])]),_:1})]),_:1})])],4)):A("",!0)],4)])]),s(I,{modelValue:t.editTitleDialog.show,"onUpdate:modelValue":e[6]||(e[6]=i=>t.editTitleDialog.show=i),"max-width":"400"},{default:o(()=>[s(j,null,{default:o(()=>[s(R,null,{default:o(()=>e[22]||(e[22]=[c("重新命名對話")])),_:1}),s(W,null,{default:o(()=>[s(U,{modelValue:t.editTitleDialog.title,"onUpdate:modelValue":e[4]||(e[4]=i=>t.editTitleDialog.title=i),label:"對話標題",variant:"outlined"},null,8,["modelValue"])]),_:1}),s(N,null,{default:o(()=>[s(C),s(_,{onClick:e[5]||(e[5]=i=>t.editTitleDialog.show=!1)},{default:o(()=>e[23]||(e[23]=[c("取消")])),_:1}),s(_,{color:"primary",onClick:t.updateSessionTitle},{default:o(()=>e[24]||(e[24]=[c("儲存")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(I,{modelValue:t.clearDialog,"onUpdate:modelValue":e[8]||(e[8]=i=>t.clearDialog=i),"max-width":"400"},{default:o(()=>[s(j,null,{default:o(()=>[s(R,null,{default:o(()=>e[25]||(e[25]=[c("清除對話")])),_:1}),s(W,null,{default:o(()=>e[26]||(e[26]=[c(" 確定要清除當前對話的所有訊息嗎？此操作無法復原。 ")])),_:1}),s(N,null,{default:o(()=>[s(C),s(_,{color:"grey",variant:"text",onClick:e[7]||(e[7]=i=>t.clearDialog=!1)},{default:o(()=>e[27]||(e[27]=[c(" 取消 ")])),_:1}),s(_,{color:"error",variant:"text",onClick:t.confirmClearSession},{default:o(()=>e[28]||(e[28]=[c(" 確定清除 ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const He=O(be,[["render",qe],["__scopeId","data-v-58f1946a"]]);const Ke={name:"UserChat",components:{EmbeddedChatInterface:pe,WebhookChatInterface:He},setup(){const f=Y(),e=Q(),m=h(null);return Z(()=>{const t=f.query.type,b=f.query.linkId;if(!t||!b){console.error("缺少必要的查詢參數"),e.push("/user-dashboard");return}t==="embedded"||t==="webhook"?m.value=t:(console.error("未知的聊天類型:",t),e.push("/user-dashboard"))}),{chatType:m}}},Fe={key:2,class:"loading-container"};function Pe(f,e,m,t,b,p){const d=l("EmbeddedChatInterface"),_=l("WebhookChatInterface"),k=l("v-progress-circular");return u(),v("div",null,[t.chatType==="embedded"?(u(),K(d,{key:0})):t.chatType==="webhook"?(u(),K(_,{key:1})):(u(),v("div",Fe,[s(k,{indeterminate:"",color:"primary",size:"64"}),e[0]||(e[0]=r("p",{class:"mt-4 text-h6"},"載入中...",-1))]))])}const Ge=O(Ke,[["render",Pe],["__scopeId","data-v-f2dbcb55"]]);export{Ge as default};
