import{_ as $,r as z,j as E,k as ee,o as le,a as d,b as c,c as C,w as o,d as I,e as a,f as k,g as r,l as ae,t as D,h as K,i as Q,F as R,m as oe,n as Y,p as B}from"./index-a1ba2a77.js";import{A as te}from"./AdminLayout-918e61dc.js";const se={name:"Users",components:{AdminLayout:te},setup(){const M=z([]),e=z(!1),T=z(""),l=E({status:"",type:""}),U=E({page:1,totalPages:1,totalItems:0,itemsPerPage:10}),X=z([{title:"使用者名稱",key:"username"},{title:"姓名",key:"full_name"},{title:"狀態",key:"is_active"},{title:"類型",key:"is_ad_user"},{title:"群組",key:"groups"},{title:"建立日期",key:"created_at"},{title:"操作",key:"actions",sortable:!1,align:"end"}]),n=E({show:!1,isEdit:!1,loading:!1,data:{id:null,username:"",password:"",full_name:"",email:"",phone:"",department:"",is_active:!0,notes:"",group_ids:[]}}),f=E({show:!1,userId:null,username:"",password:"",loading:!1}),m=E({show:!1,userId:null,username:"",selectedGroups:[],search:"",loading:!1}),p=E({show:!1,userId:null,username:"",loading:!1}),G=E({show:!1,text:"",color:"success"}),v=z([]),x=z(null),b=z(null),S=s=>new Date(s).toLocaleDateString("zh-TW"),_=async(s=U.page)=>{e.value=!0,U.page=s;try{const i={page:U.page,page_size:U.itemsPerPage,search:T.value||void 0};l.status!==""&&(i.is_active=l.status),l.type==="platform"?i.is_ad_user=!1:l.type==="ad"&&(i.is_ad_user=!0);const u=await I.get("/api/users",{params:i});u.data.success&&(M.value=u.data.items,U.totalPages=u.data.total_pages,U.totalItems=u.data.total)}catch(i){console.error("獲取使用者失敗:",i),w("獲取使用者失敗","error")}finally{e.value=!1}},P=async()=>{try{const s=await I.get("/api/groups");s.data.success&&(v.value=s.data.items)}catch(s){console.error("獲取群組失敗:",s)}},W=()=>{n.isEdit=!1,n.data={id:null,username:"",password:"",full_name:"",email:"",phone:"",department:"",is_active:!0,notes:"",group_ids:[]},n.show=!0},N=s=>{n.isEdit=!0,n.data={id:s.id,username:s.username,full_name:s.full_name,email:s.email||"",phone:s.phone||"",department:s.department||"",is_active:s.is_active,notes:s.notes||"",group_ids:s.groups.map(i=>i.id)},n.show=!0},h=s=>{f.userId=s.id,f.username=s.username,f.password="",f.show=!0},q=s=>{m.userId=s.id,m.username=s.username,m.selectedGroups=s.groups.map(i=>i.id),m.search="",m.show=!0},H=s=>{p.userId=s.id,p.username=s.username,p.show=!0},V=async()=>{var i,u;const{valid:s}=await x.value.validate();if(s){n.loading=!0;try{let g;n.isEdit?g=await I.put(`/api/users/${n.data.id}`,{full_name:n.data.full_name,email:n.data.email,phone:n.data.phone,department:n.data.department,is_active:n.data.is_active,notes:n.data.notes}):g=await I.post("/api/users",{username:n.data.username,password:n.data.password,full_name:n.data.full_name,email:n.data.email,phone:n.data.phone,department:n.data.department,is_active:n.data.is_active,notes:n.data.notes}),g.data.success&&(n.show=!1,_(),w(n.isEdit?"使用者更新成功":"使用者建立成功"))}catch(g){console.error("儲存使用者失敗:",g),w(((u=(i=g.response)==null?void 0:i.data)==null?void 0:u.detail)||"儲存使用者失敗","error")}finally{n.loading=!1}}},F=async()=>{var i,u;const{valid:s}=await b.value.validate();if(s){f.loading=!0;try{(await I.put(`/api/users/${f.userId}/password`,{password:f.password})).data.success&&(f.show=!1,w("密碼更新成功"))}catch(g){console.error("更新密碼失敗:",g),w(((u=(i=g.response)==null?void 0:i.data)==null?void 0:u.detail)||"更新密碼失敗","error")}finally{f.loading=!1}}},J=ee(()=>{if(!m.search)return v.value;const s=m.search.toLowerCase();return v.value.filter(i=>i.name.toLowerCase().includes(s))}),O=s=>{const i=v.value.find(u=>u.id===s);return i?i.name:"未知群組"},j=s=>{m.selectedGroups=m.selectedGroups.filter(i=>i!==s)},L=async()=>{var s,i;m.loading=!0;try{(await I.put(`/api/users/${m.userId}`,{group_ids:m.selectedGroups})).data.success&&(m.show=!1,_(),w("使用者群組更新成功"))}catch(u){console.error("更新使用者群組失敗:",u),w(((i=(s=u.response)==null?void 0:s.data)==null?void 0:i.detail)||"更新使用者群組失敗","error")}finally{m.loading=!1}},A=async()=>{var s,i;p.loading=!0;try{(await I.delete(`/api/users/${p.userId}`)).data.success&&(p.show=!1,_(),w("使用者已刪除"))}catch(u){console.error("刪除使用者失敗:",u),w(((i=(s=u.response)==null?void 0:s.data)==null?void 0:i.detail)||"刪除使用者失敗","error")}finally{p.loading=!1}},w=(s,i="success")=>{G.text=s,G.color=i,G.show=!0};return le(()=>{_(),P()}),{users:M,loading:e,search:T,filters:l,pagination:U,headers:X,userDialog:n,passwordDialog:f,groupDialog:m,deleteDialog:p,snackbar:G,allGroups:v,userForm:x,passwordForm:b,formatDate:S,fetchUsers:_,openCreateDialog:W,openEditDialog:N,openPasswordDialog:h,openGroupDialog:q,confirmDelete:H,saveUser:V,updatePassword:F,updateUserGroups:L,deleteUser:A,filteredGroups:J,getGroupNameById:O,removeGroupFromSelection:j}}},ne={class:"d-flex align-center justify-space-between mb-6"},re={class:"d-flex justify-center pt-4 pb-3"},ie={class:"mb-4"},de={class:"d-flex align-center mb-2"},ue={class:"text-subtitle-2"},me={key:0,class:"text-body-2 text-grey"};function pe(M,e,T,l,U,X){const n=d("v-btn"),f=d("v-col"),m=d("v-row"),p=d("v-text-field"),G=d("v-select"),v=d("v-card-text"),x=d("v-card"),b=d("v-chip"),S=d("v-icon"),_=d("v-list-item-title"),P=d("v-list-item"),W=d("v-divider"),N=d("v-list"),h=d("v-menu"),q=d("v-data-table"),H=d("v-pagination"),V=d("v-spacer"),F=d("v-card-title"),J=d("v-switch"),O=d("v-textarea"),j=d("v-form"),L=d("v-card-actions"),A=d("v-dialog"),w=d("v-checkbox"),s=d("v-list-item-subtitle"),i=d("v-sheet"),u=d("v-chip-group"),g=d("v-snackbar"),Z=d("AdminLayout");return c(),C(Z,null,{default:o(()=>[a(m,null,{default:o(()=>[a(f,{cols:"12"},{default:o(()=>[k("div",ne,[e[30]||(e[30]=k("h1",{class:"text-h4"},"使用者管理",-1)),a(n,{color:"primary","prepend-icon":"mdi-account-plus",onClick:l.openCreateDialog},{default:o(()=>e[29]||(e[29]=[r(" 新增使用者 ")])),_:1},8,["onClick"])])]),_:1})]),_:1}),a(x,{class:"mb-4"},{default:o(()=>[a(v,null,{default:o(()=>[a(m,null,{default:o(()=>[a(f,{cols:"12",md:"4"},{default:o(()=>[a(p,{modelValue:l.search,"onUpdate:modelValue":e[0]||(e[0]=t=>l.search=t),label:"搜尋使用者","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",class:"mb-3 mb-md-0",onKeyup:ae(l.fetchUsers,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),a(f,{cols:"6",md:"3"},{default:o(()=>[a(G,{modelValue:l.filters.status,"onUpdate:modelValue":[e[1]||(e[1]=t=>l.filters.status=t),l.fetchUsers],label:"狀態",items:[{value:"",title:"所有狀態"},{value:!0,title:"啟用"},{value:!1,title:"停用"}],"item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(f,{cols:"6",md:"3"},{default:o(()=>[a(G,{modelValue:l.filters.type,"onUpdate:modelValue":[e[2]||(e[2]=t=>l.filters.type=t),l.fetchUsers],label:"類型",items:[{value:"",title:"所有類型"},{value:"platform",title:"平台帳號"},{value:"ad",title:"AD 帳號"}],"item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(f,{cols:"12",md:"2"},{default:o(()=>[a(n,{color:"primary",variant:"tonal",block:"",onClick:l.fetchUsers},{default:o(()=>e[31]||(e[31]=[r(" 搜尋 ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1}),a(x,null,{default:o(()=>[a(q,{headers:l.headers,items:l.users,loading:l.loading,"items-per-page":10,class:"elevation-1"},{"item.is_active":o(({item:t})=>[a(b,{color:t.is_active?"success":"error",size:"small"},{default:o(()=>[r(D(t.is_active?"啟用":"停用"),1)]),_:2},1032,["color"])]),"item.is_ad_user":o(({item:t})=>[a(b,{color:t.is_ad_user?"info":"secondary",size:"small"},{default:o(()=>[r(D(t.is_ad_user?"AD 帳號":"平台帳號"),1)]),_:2},1032,["color"])]),"item.groups":o(({item:t})=>[(c(!0),K(R,null,Q(t.groups,y=>(c(),C(b,{key:y.id,color:"primary",size:"small",class:"mr-1 mb-1",variant:"outlined"},{default:o(()=>[r(D(y.name),1)]),_:2},1024))),128))]),"item.created_at":o(({item:t})=>[r(D(l.formatDate(t.created_at)),1)]),"item.actions":o(({item:t})=>[a(h,null,{activator:o(({props:y})=>[a(n,oe(y,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:o(()=>[a(N,null,{default:o(()=>[a(P,{onClick:y=>l.openEditDialog(t)},{default:o(()=>[a(_,null,{default:o(()=>[a(S,{start:""},{default:o(()=>e[32]||(e[32]=[r("mdi-pencil")])),_:1}),e[33]||(e[33]=r(" 編輯 "))]),_:1})]),_:2},1032,["onClick"]),a(P,{onClick:y=>l.openPasswordDialog(t)},{default:o(()=>[a(_,null,{default:o(()=>[a(S,{start:""},{default:o(()=>e[34]||(e[34]=[r("mdi-key")])),_:1}),e[35]||(e[35]=r(" 修改密碼 "))]),_:1})]),_:2},1032,["onClick"]),a(P,{onClick:y=>l.openGroupDialog(t)},{default:o(()=>[a(_,null,{default:o(()=>[a(S,{start:""},{default:o(()=>e[36]||(e[36]=[r("mdi-account-group")])),_:1}),e[37]||(e[37]=r(" 管理群組 "))]),_:1})]),_:2},1032,["onClick"]),a(W),a(P,{onClick:y=>l.confirmDelete(t),class:"text-error"},{default:o(()=>[a(_,null,{default:o(()=>[a(S,{start:""},{default:o(()=>e[38]||(e[38]=[r("mdi-delete")])),_:1}),e[39]||(e[39]=r(" 刪除 "))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:1},8,["headers","items","loading"]),k("div",re,[a(H,{modelValue:l.pagination.page,"onUpdate:modelValue":[e[3]||(e[3]=t=>l.pagination.page=t),l.fetchUsers],length:l.pagination.totalPages,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])]),_:1}),a(A,{modelValue:l.userDialog.show,"onUpdate:modelValue":e[14]||(e[14]=t=>l.userDialog.show=t),"max-width":"600px"},{default:o(()=>[a(x,null,{default:o(()=>[a(F,{class:"bg-primary text-white"},{default:o(()=>[r(D(l.userDialog.isEdit?"編輯使用者":"新增使用者")+" ",1),a(V),a(n,{icon:"mdi-close",variant:"text",color:"white",onClick:e[4]||(e[4]=t=>l.userDialog.show=!1)})]),_:1}),a(v,{class:"pt-4"},{default:o(()=>[a(j,{ref:"userForm",onSubmit:Y(l.saveUser,["prevent"])},{default:o(()=>[a(p,{modelValue:l.userDialog.data.username,"onUpdate:modelValue":e[5]||(e[5]=t=>l.userDialog.data.username=t),label:"使用者名稱",readonly:l.userDialog.isEdit,rules:[t=>!!t||"請輸入使用者名稱"],variant:"outlined",class:"mb-3"},null,8,["modelValue","readonly","rules"]),l.userDialog.isEdit?B("",!0):(c(),C(p,{key:0,modelValue:l.userDialog.data.password,"onUpdate:modelValue":e[6]||(e[6]=t=>l.userDialog.data.password=t),label:"密碼",type:"password",rules:[t=>!!t||"請輸入密碼"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"])),a(p,{modelValue:l.userDialog.data.full_name,"onUpdate:modelValue":e[7]||(e[7]=t=>l.userDialog.data.full_name=t),label:"姓名",rules:[t=>!!t||"請輸入姓名"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"]),a(p,{modelValue:l.userDialog.data.email,"onUpdate:modelValue":e[8]||(e[8]=t=>l.userDialog.data.email=t),label:"電子郵件",variant:"outlined",class:"mb-3"},null,8,["modelValue"]),a(p,{modelValue:l.userDialog.data.phone,"onUpdate:modelValue":e[9]||(e[9]=t=>l.userDialog.data.phone=t),label:"電話",variant:"outlined",class:"mb-3"},null,8,["modelValue"]),a(p,{modelValue:l.userDialog.data.department,"onUpdate:modelValue":e[10]||(e[10]=t=>l.userDialog.data.department=t),label:"部門",variant:"outlined",class:"mb-3"},null,8,["modelValue"]),a(J,{modelValue:l.userDialog.data.is_active,"onUpdate:modelValue":e[11]||(e[11]=t=>l.userDialog.data.is_active=t),label:"啟用使用者",color:"success","hide-details":"",class:"mb-3"},null,8,["modelValue"]),a(O,{modelValue:l.userDialog.data.notes,"onUpdate:modelValue":e[12]||(e[12]=t=>l.userDialog.data.notes=t),label:"備註",variant:"outlined","auto-grow":"",class:"mb-3"},null,8,["modelValue"])]),_:1},8,["onSubmit"])]),_:1}),a(L,{class:"pb-4 px-4"},{default:o(()=>[a(V),a(n,{color:"error",variant:"text",onClick:e[13]||(e[13]=t=>l.userDialog.show=!1)},{default:o(()=>e[40]||(e[40]=[r(" 取消 ")])),_:1}),a(n,{color:"primary",onClick:l.saveUser,loading:l.userDialog.loading},{default:o(()=>e[41]||(e[41]=[r(" 儲存 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(A,{modelValue:l.passwordDialog.show,"onUpdate:modelValue":e[18]||(e[18]=t=>l.passwordDialog.show=t),"max-width":"500px"},{default:o(()=>[a(x,null,{default:o(()=>[a(F,{class:"bg-primary text-white"},{default:o(()=>[e[42]||(e[42]=r(" 修改密碼 ")),a(V),a(n,{icon:"mdi-close",variant:"text",color:"white",onClick:e[15]||(e[15]=t=>l.passwordDialog.show=!1)})]),_:1}),a(v,{class:"pt-4"},{default:o(()=>[a(j,{ref:"passwordForm",onSubmit:Y(l.updatePassword,["prevent"])},{default:o(()=>[a(p,{modelValue:l.passwordDialog.password,"onUpdate:modelValue":e[16]||(e[16]=t=>l.passwordDialog.password=t),label:"新密碼",type:"password",rules:[t=>!!t||"請輸入新密碼"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"])]),_:1},8,["onSubmit"])]),_:1}),a(L,{class:"pb-4 px-4"},{default:o(()=>[a(V),a(n,{color:"error",variant:"text",onClick:e[17]||(e[17]=t=>l.passwordDialog.show=!1)},{default:o(()=>e[43]||(e[43]=[r(" 取消 ")])),_:1}),a(n,{color:"primary",onClick:l.updatePassword,loading:l.passwordDialog.loading},{default:o(()=>e[44]||(e[44]=[r(" 更新密碼 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(A,{modelValue:l.groupDialog.show,"onUpdate:modelValue":e[24]||(e[24]=t=>l.groupDialog.show=t),"max-width":"600px"},{default:o(()=>[a(x,null,{default:o(()=>[a(F,{class:"bg-primary text-white"},{default:o(()=>[e[45]||(e[45]=r(" 管理使用者群組 ")),a(V),a(n,{icon:"mdi-close",variant:"text",color:"white",onClick:e[19]||(e[19]=t=>l.groupDialog.show=!1)})]),_:1}),a(v,{class:"pt-4"},{default:o(()=>[k("p",ie,[e[46]||(e[46]=r("為使用者 ")),k("strong",null,D(l.groupDialog.username),1),e[47]||(e[47]=r(" 選擇群組："))]),a(p,{modelValue:l.groupDialog.search,"onUpdate:modelValue":e[20]||(e[20]=t=>l.groupDialog.search=t),label:"搜尋群組","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",class:"mb-3","hide-details":"",clearable:""},null,8,["modelValue"]),a(i,{"max-height":"300px",class:"overflow-y-auto"},{default:o(()=>[a(N,null,{default:o(()=>[(c(!0),K(R,null,Q(l.filteredGroups,t=>(c(),C(P,{key:t.id,value:t.id,density:"compact",class:"px-0"},{prepend:o(()=>[a(w,{modelValue:l.groupDialog.selectedGroups,"onUpdate:modelValue":e[21]||(e[21]=y=>l.groupDialog.selectedGroups=y),value:t.id,"hide-details":"",density:"compact"},null,8,["modelValue","value"])]),default:o(()=>[a(_,{class:"text-subtitle-2"},{default:o(()=>[r(D(t.name),1)]),_:2},1024),a(s,null,{default:o(()=>[t.can_login?(c(),C(b,{key:0,size:"x-small",color:"success",class:"mr-1"},{default:o(()=>e[48]||(e[48]=[r(" 可登入 ")])),_:1})):B("",!0),t.can_manage_platform?(c(),C(b,{key:1,size:"x-small",color:"error",class:"mr-1"},{default:o(()=>e[49]||(e[49]=[r(" 可管理 ")])),_:1})):B("",!0),t.can_use_chat_links?(c(),C(b,{key:2,size:"x-small",color:"info",class:"mr-1"},{default:o(()=>e[50]||(e[50]=[r(" 可使用聊天 ")])),_:1})):B("",!0)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})]),_:1}),a(i,{class:"mt-4 pa-3 bg-grey-lighten-4 rounded"},{default:o(()=>[k("div",de,[k("div",ue,"已選擇的群組 ("+D(l.groupDialog.selectedGroups.length)+")",1),a(V),l.groupDialog.selectedGroups.length>0?(c(),C(n,{key:0,size:"small",variant:"text",color:"error",onClick:e[22]||(e[22]=t=>l.groupDialog.selectedGroups=[])},{default:o(()=>e[51]||(e[51]=[r(" 清除全部 ")])),_:1})):B("",!0)]),l.groupDialog.selectedGroups.length===0?(c(),K("div",me," 尚未選擇任何群組 ")):B("",!0),a(u,null,{default:o(()=>[(c(!0),K(R,null,Q(l.groupDialog.selectedGroups,t=>(c(),C(b,{key:t,closable:"",color:"primary",size:"small","onClick:close":y=>l.removeGroupFromSelection(t)},{default:o(()=>[r(D(l.getGroupNameById(t)),1)]),_:2},1032,["onClick:close"]))),128))]),_:1})]),_:1})]),_:1}),a(L,{class:"pb-4 px-4"},{default:o(()=>[a(V),a(n,{color:"error",variant:"text",onClick:e[23]||(e[23]=t=>l.groupDialog.show=!1)},{default:o(()=>e[52]||(e[52]=[r(" 取消 ")])),_:1}),a(n,{color:"primary",onClick:l.updateUserGroups,loading:l.groupDialog.loading},{default:o(()=>e[53]||(e[53]=[r(" 儲存群組設定 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(A,{modelValue:l.deleteDialog.show,"onUpdate:modelValue":e[26]||(e[26]=t=>l.deleteDialog.show=t),"max-width":"500"},{default:o(()=>[a(x,null,{default:o(()=>[a(F,{class:"bg-error text-white"},{default:o(()=>e[54]||(e[54]=[r(" 刪除使用者 ")])),_:1}),a(v,{class:"pt-4"},{default:o(()=>[k("p",null,[e[55]||(e[55]=r("確定要刪除使用者 ")),k("strong",null,D(l.deleteDialog.username),1),e[56]||(e[56]=r(" 嗎？"))]),e[57]||(e[57]=k("p",{class:"text-caption text-grey"},"此操作無法復原。",-1))]),_:1}),a(L,null,{default:o(()=>[a(V),a(n,{color:"grey",variant:"text",onClick:e[25]||(e[25]=t=>l.deleteDialog.show=!1)},{default:o(()=>e[58]||(e[58]=[r(" 取消 ")])),_:1}),a(n,{color:"error",variant:"flat",onClick:l.deleteUser,loading:l.deleteDialog.loading},{default:o(()=>e[59]||(e[59]=[r(" 刪除 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(g,{modelValue:l.snackbar.show,"onUpdate:modelValue":e[28]||(e[28]=t=>l.snackbar.show=t),color:l.snackbar.color,timeout:3e3},{actions:o(()=>[a(n,{variant:"text",onClick:e[27]||(e[27]=t=>l.snackbar.show=!1)},{default:o(()=>e[60]||(e[60]=[r(" 關閉 ")])),_:1})]),default:o(()=>[r(D(l.snackbar.text)+" ",1)]),_:1},8,["modelValue","color"])]),_:1})}const ge=$(se,[["render",pe]]);export{ge as default};
