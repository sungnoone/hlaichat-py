import{_ as Q,r as B,j as N,o as Y,a as c,b as E,c as Z,w as o,e as n,f as j,g as _,h as U,t as T,m as $,n as ee}from"./index-a1ba2a77.js";import{A as te}from"./AdminLayout-918e61dc.js";import{c as z}from"./api-26b8bab1.js";var ae=typeof global=="object"&&global&&global.Object===Object&&global;const ne=ae;var oe=typeof self=="object"&&self&&self.Object===Object&&self,ie=ne||oe||Function("return this")();const H=ie;var le=H.Symbol;const L=le;var X=Object.prototype,re=X.hasOwnProperty,se=X.toString,P=L?L.toStringTag:void 0;function de(a){var e=re.call(a,P),m=a[P];try{a[P]=void 0;var t=!0}catch{}var r=se.call(a);return t&&(e?a[P]=m:delete a[P]),r}var ce=Object.prototype,fe=ce.toString;function me(a){return fe.call(a)}var ue="[object Null]",ge="[object Undefined]",F=L?L.toStringTag:void 0;function pe(a){return a==null?a===void 0?ge:ue:F&&F in Object(a)?de(a):me(a)}function _e(a){return a!=null&&typeof a=="object"}var ve="[object Symbol]";function ye(a){return typeof a=="symbol"||_e(a)&&pe(a)==ve}var be=/\s/;function ke(a){for(var e=a.length;e--&&be.test(a.charAt(e)););return e}var we=/^\s+/;function xe(a){return a&&a.slice(0,ke(a)+1).replace(we,"")}function W(a){var e=typeof a;return a!=null&&(e=="object"||e=="function")}var R=0/0,Ce=/^[-+]0x[0-9a-f]+$/i,he=/^0b[01]+$/i,De=/^0o[0-7]+$/i,Se=parseInt;function G(a){if(typeof a=="number")return a;if(ye(a))return R;if(W(a)){var e=typeof a.valueOf=="function"?a.valueOf():a;a=W(e)?e+"":e}if(typeof a!="string")return a===0?a:+a;a=xe(a);var m=he.test(a);return m||De.test(a)?Se(a.slice(2),m?2:8):Ce.test(a)?R:+a}var Te=function(){return H.Date.now()};const M=Te;var Ve="Expected a function",je=Math.max,Ie=Math.min;function Ae(a,e,m){var t,r,g,s,f,v,u=0,D=!1,k=!1,w=!0;if(typeof a!="function")throw new TypeError(Ve);e=G(e)||0,W(m)&&(D=!!m.leading,k="maxWait"in m,g=k?je(G(m.maxWait)||0,e):g,w="trailing"in m?!!m.trailing:w);function S(d){var b=t,h=r;return t=r=void 0,u=d,s=a.apply(h,b),s}function I(d){return u=d,f=setTimeout(x,e),D?S(d):s}function A(d){var b=d-v,h=d-u,K=e-b;return k?Ie(K,g-h):K}function V(d){var b=d-v,h=d-u;return v===void 0||b>=e||b<0||k&&h>=g}function x(){var d=M();if(V(d))return C(d);f=setTimeout(x,A(d))}function C(d){return f=void 0,w&&t?S(d):(t=r=void 0,s)}function p(){f!==void 0&&clearTimeout(f),u=0,t=v=r=f=void 0}function l(){return f===void 0?s:C(M())}function y(){var d=M(),b=V(d);if(t=arguments,r=this,v=d,b){if(f===void 0)return I(v);if(k)return clearTimeout(f),f=setTimeout(x,e),S(v)}return f===void 0&&(f=setTimeout(x,e)),s}return y.cancel=p,y.flush=l,y}const Ke={name:"Credentials",components:{AdminLayout:te},setup(){const a=B(!1),e=B([]),m=B(""),t=N({page:1,pageSize:10,total:0,totalPages:0}),r=N({show:!1,isEdit:!1,loading:!1,showApiKey:!1,data:{name:"",api_key:"",description:""}}),g=N({show:!1,loading:!1,credentialId:null,credentialName:""}),s=N({show:!1,message:"",color:"success"}),f=[{title:"憑證名稱",key:"name",sortable:!0},{title:"API Key",key:"api_key",sortable:!1},{title:"描述",key:"description",sortable:!1},{title:"創建時間",key:"created_at",sortable:!0},{title:"更新時間",key:"updated_at",sortable:!0},{title:"操作",key:"actions",sortable:!1}],v=Ae(()=>{t.page=1,u()},500),u=async()=>{a.value=!0;try{const l={skip:(t.page-1)*t.pageSize,limit:t.pageSize};m.value&&(l.search=m.value);const y=await z.getCredentials(l);e.value=y.credentials.map(d=>({...d,showKey:!1})),t.total=y.total,t.totalPages=Math.ceil(y.total/t.pageSize)}catch(l){p("取得憑證列表失敗","error"),console.error("取得憑證列表失敗:",l)}finally{a.value=!1}},D=()=>{r.isEdit=!1,r.data={name:"",api_key:"",description:""},r.showApiKey=!1,r.show=!0},k=l=>{r.isEdit=!0,r.data={...l},r.showApiKey=!1,r.show=!0},w=async()=>{r.loading=!0;try{r.isEdit?(await z.updateCredential(r.data.id,r.data),p("憑證更新成功")):(await z.createCredential(r.data),p("憑證建立成功")),r.show=!1,await u()}catch(l){p(r.isEdit?"憑證更新失敗":"憑證建立失敗","error"),console.error("儲存憑證失敗:",l)}finally{r.loading=!1}},S=l=>{g.credentialId=l.id,g.credentialName=l.name,g.show=!0},I=async()=>{g.loading=!0;try{await z.deleteCredential(g.credentialId),p("憑證刪除成功"),g.show=!1,await u()}catch(l){p("憑證刪除失敗","error"),console.error("刪除憑證失敗:",l)}finally{g.loading=!1}},A=l=>{l.showKey=!l.showKey},V=async l=>{try{await navigator.clipboard.writeText(l),p("API Key 已複製到剪貼簿")}catch{p("複製失敗","error")}},x=()=>{m.value="",t.page=1,u()},C=l=>l?new Date(l).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",p=(l,y="success")=>{s.message=l,s.color=y,s.show=!0};return Y(()=>{u()}),{loading:a,credentials:e,search:m,pagination:t,credentialDialog:r,deleteDialog:g,snackbar:s,headers:f,debouncedSearch:v,fetchCredentials:u,openCreateDialog:D,openEditDialog:k,saveCredential:w,confirmDelete:S,deleteCredential:I,toggleKeyVisibility:A,copyToClipboard:V,resetSearch:x,formatDate:C}}},Oe={class:"d-flex align-center justify-space-between mb-6"},Ee={class:"d-flex align-center"},Pe={key:0,class:"text-grey"},Ne={key:1,class:"font-monospace"},Ue={key:0,class:"text-truncate",style:{"max-width":"200px"}},ze={key:1,class:"text-grey"},Le={class:"d-flex justify-center pt-4 pb-3"};function Be(a,e,m,t,r,g){const s=c("v-btn"),f=c("v-col"),v=c("v-row"),u=c("v-text-field"),D=c("v-icon"),k=c("v-list-item-title"),w=c("v-list-item"),S=c("v-divider"),I=c("v-list"),A=c("v-menu"),V=c("v-data-table"),x=c("v-pagination"),C=c("v-card"),p=c("v-spacer"),l=c("v-card-title"),y=c("v-textarea"),d=c("v-form"),b=c("v-card-text"),h=c("v-card-actions"),K=c("v-dialog"),q=c("v-snackbar"),J=c("AdminLayout");return E(),Z(J,null,{default:o(()=>[n(v,null,{default:o(()=>[n(f,{cols:"12"},{default:o(()=>[j("div",Oe,[e[14]||(e[14]=j("h1",{class:"text-h4"},"憑證管理",-1)),n(s,{color:"primary","prepend-icon":"mdi-key-variant",onClick:t.openCreateDialog},{default:o(()=>e[13]||(e[13]=[_(" 新增憑證 ")])),_:1},8,["onClick"])])]),_:1})]),_:1}),n(v,{class:"mb-4"},{default:o(()=>[n(f,{cols:"12",md:"6"},{default:o(()=>[n(u,{modelValue:t.search,"onUpdate:modelValue":e[0]||(e[0]=i=>t.search=i),label:"搜尋憑證","prepend-inner-icon":"mdi-magnify",variant:"outlined",clearable:"",onInput:t.debouncedSearch},null,8,["modelValue","onInput"])]),_:1}),n(f,{cols:"12",md:"6"},{default:o(()=>[n(s,{color:"secondary",variant:"outlined",onClick:t.resetSearch},{default:o(()=>e[15]||(e[15]=[_(" 重置搜尋 ")])),_:1},8,["onClick"])]),_:1})]),_:1}),n(v,null,{default:o(()=>[n(f,{cols:"12"},{default:o(()=>[n(C,null,{default:o(()=>[n(V,{headers:t.headers,items:t.credentials,loading:t.loading,"items-per-page":t.pagination.pageSize,"hide-default-footer":"",class:"elevation-1"},{"item.api_key":o(({item:i})=>[j("div",Ee,[i.showKey?(E(),U("span",Ne,T(i.api_key),1)):(E(),U("span",Pe," •••••••••••••••• ")),n(s,{icon:i.showKey?"mdi-eye-off":"mdi-eye",variant:"text",size:"small",onClick:O=>t.toggleKeyVisibility(i),class:"ml-2"},null,8,["icon","onClick"]),n(s,{icon:"mdi-content-copy",variant:"text",size:"small",onClick:O=>t.copyToClipboard(i.api_key),class:"ml-1"},null,8,["onClick"])])]),"item.description":o(({item:i})=>[i.description?(E(),U("span",Ue,T(i.description),1)):(E(),U("span",ze," 無描述 "))]),"item.created_at":o(({item:i})=>[_(T(t.formatDate(i.created_at)),1)]),"item.updated_at":o(({item:i})=>[_(T(t.formatDate(i.updated_at)),1)]),"item.actions":o(({item:i})=>[n(A,null,{activator:o(({props:O})=>[n(s,$(O,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:o(()=>[n(I,null,{default:o(()=>[n(w,{onClick:O=>t.openEditDialog(i)},{default:o(()=>[n(k,null,{default:o(()=>[n(D,{start:""},{default:o(()=>e[16]||(e[16]=[_("mdi-pencil")])),_:1}),e[17]||(e[17]=_(" 編輯 "))]),_:1})]),_:2},1032,["onClick"]),n(S),n(w,{onClick:O=>t.confirmDelete(i),class:"text-error"},{default:o(()=>[n(k,null,{default:o(()=>[n(D,{start:""},{default:o(()=>e[18]||(e[18]=[_("mdi-delete")])),_:1}),e[19]||(e[19]=_(" 刪除 "))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:1},8,["headers","items","loading","items-per-page"]),j("div",Le,[n(x,{modelValue:t.pagination.page,"onUpdate:modelValue":[e[1]||(e[1]=i=>t.pagination.page=i),t.fetchCredentials],length:t.pagination.totalPages,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])]),_:1})]),_:1})]),_:1}),n(K,{modelValue:t.credentialDialog.show,"onUpdate:modelValue":e[8]||(e[8]=i=>t.credentialDialog.show=i),"max-width":"600px"},{default:o(()=>[n(C,null,{default:o(()=>[n(l,{class:"bg-primary text-white"},{default:o(()=>[_(T(t.credentialDialog.isEdit?"編輯憑證":"新增憑證")+" ",1),n(p),n(s,{icon:"mdi-close",variant:"text",color:"white",onClick:e[2]||(e[2]=i=>t.credentialDialog.show=!1)})]),_:1}),n(b,{class:"pt-4"},{default:o(()=>[n(d,{ref:"credentialForm",onSubmit:ee(t.saveCredential,["prevent"])},{default:o(()=>[n(u,{modelValue:t.credentialDialog.data.name,"onUpdate:modelValue":e[3]||(e[3]=i=>t.credentialDialog.data.name=i),label:"憑證名稱",rules:[i=>!!i||"請輸入憑證名稱"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"]),n(u,{modelValue:t.credentialDialog.data.api_key,"onUpdate:modelValue":e[5]||(e[5]=i=>t.credentialDialog.data.api_key=i),label:"API Key",type:t.credentialDialog.showApiKey?"text":"password",rules:[i=>!!i||"請輸入 API Key"],variant:"outlined",class:"mb-3"},{"append-inner":o(()=>[n(s,{icon:t.credentialDialog.showApiKey?"mdi-eye-off":"mdi-eye",variant:"text",size:"small",onClick:e[4]||(e[4]=i=>t.credentialDialog.showApiKey=!t.credentialDialog.showApiKey)},null,8,["icon"])]),_:1},8,["modelValue","type","rules"]),n(y,{modelValue:t.credentialDialog.data.description,"onUpdate:modelValue":e[6]||(e[6]=i=>t.credentialDialog.data.description=i),label:"描述",variant:"outlined","auto-grow":"",class:"mb-3"},null,8,["modelValue"])]),_:1},8,["onSubmit"])]),_:1}),n(h,{class:"pb-4 px-4"},{default:o(()=>[n(p),n(s,{color:"error",variant:"text",onClick:e[7]||(e[7]=i=>t.credentialDialog.show=!1)},{default:o(()=>e[20]||(e[20]=[_(" 取消 ")])),_:1}),n(s,{color:"primary",onClick:t.saveCredential,loading:t.credentialDialog.loading},{default:o(()=>e[21]||(e[21]=[_(" 儲存 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(K,{modelValue:t.deleteDialog.show,"onUpdate:modelValue":e[11]||(e[11]=i=>t.deleteDialog.show=i),"max-width":"400px"},{default:o(()=>[n(C,null,{default:o(()=>[n(l,{class:"bg-error text-white"},{default:o(()=>[e[22]||(e[22]=_(" 確認刪除 ")),n(p),n(s,{icon:"mdi-close",variant:"text",color:"white",onClick:e[9]||(e[9]=i=>t.deleteDialog.show=!1)})]),_:1}),n(b,{class:"pt-4"},{default:o(()=>[j("p",null,"確定要刪除憑證「"+T(t.deleteDialog.credentialName)+"」嗎？",1),e[23]||(e[23]=j("p",{class:"text-error"},"此操作無法復原。",-1))]),_:1}),n(h,{class:"pb-4 px-4"},{default:o(()=>[n(p),n(s,{color:"grey",variant:"text",onClick:e[10]||(e[10]=i=>t.deleteDialog.show=!1)},{default:o(()=>e[24]||(e[24]=[_(" 取消 ")])),_:1}),n(s,{color:"error",onClick:t.deleteCredential,loading:t.deleteDialog.loading},{default:o(()=>e[25]||(e[25]=[_(" 刪除 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(q,{modelValue:t.snackbar.show,"onUpdate:modelValue":e[12]||(e[12]=i=>t.snackbar.show=i),color:t.snackbar.color,timeout:3e3,location:"top"},{default:o(()=>[_(T(t.snackbar.message),1)]),_:1},8,["modelValue","color"])]),_:1})}const Re=Q(Ke,[["render",Be],["__scopeId","data-v-d1cd961a"]]);export{Re as default};
