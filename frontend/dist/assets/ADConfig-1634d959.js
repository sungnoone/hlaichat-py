import{_ as X,r as w,j as T,k as q,o as Y,a as r,b as u,c as A,w as t,d as V,e as a,f as d,g as o,n as E,p as g,h as b,t as m,F as O,i as H}from"./index-a1ba2a77.js";import{A as Z}from"./AdminLayout-918e61dc.js";const $={name:"ADConfig",components:{AdminLayout:Z},setup(){const U=w({configured:!1}),e=w({domain_name:"",primary_dc:"",secondary_dcs:"",bind_username:"",bind_password:""}),x=T({test:!1,save:!1,search:!1,addUser:!1}),s=w(""),G=w([]),L=w(!1),S=w([]),_=T({show:!1,user:{username:"",full_name:"",display_name:"",email:"",department:"",description:"",title:"",guid:""},selectedGroups:[]}),D=T({show:!1,text:"",color:"success"}),C=w(null),k=w(null),F=w(10),c=[10,20,30,40,50],p=q(()=>e.value.domain_name&&e.value.primary_dc&&e.value.bind_username&&e.value.bind_password),N=q(()=>p.value),B=async()=>{try{const n=await V.get("/api/ad-config/status");if(U.value=n.data.data,U.value.configured){const i=await V.get("/api/ad-config");i.data.success&&(e.value=i.data.data)}}catch(n){console.error("獲取 AD 設定失敗:",n),y("獲取 AD 設定失敗","error")}},z=async()=>{try{const n=await V.get("/api/groups");n.data.success&&(S.value=n.data.items||[])}catch(n){console.error("獲取群組失敗:",n)}},h=async()=>{var n,i;if(p.value){x.test=!0;try{(await V.post("/api/ad-config/test-connection",{domain_name:e.value.domain_name,primary_dc:e.value.primary_dc,bind_username:e.value.bind_username,bind_password:e.value.bind_password})).data.success&&y("AD 連線測試成功","success")}catch(f){console.error("AD 連線測試失敗:",f),y(((i=(n=f.response)==null?void 0:n.data)==null?void 0:i.detail)||"AD 連線測試失敗","error")}finally{x.test=!1}}},j=async()=>{var i,f;const{valid:n}=await C.value.validate();if(n){x.save=!0;try{(await V.put("/api/ad-config",e.value)).data.success&&(U.value.configured=!0,y("AD 設定已儲存","success"))}catch(v){console.error("儲存 AD 設定失敗:",v),y(((f=(i=v.response)==null?void 0:i.data)==null?void 0:f.detail)||"儲存 AD 設定失敗","error")}finally{x.save=!1}}},R=async()=>{var i,f;const{valid:n}=await k.value.validate();if(!(!n||!U.value.configured)){x.search=!0,G.value=[],L.value=!1;try{const v=await V.post("/api/ad-config/search-users",{search_term:s.value,max_results:F.value});v.data.success&&(G.value=v.data.data||[],L.value=G.value.length===0)}catch(v){console.error("搜尋 AD 使用者失敗:",v),y(((f=(i=v.response)==null?void 0:i.data)==null?void 0:f.detail)||"搜尋 AD 使用者失敗","error")}finally{x.search=!1}}},P=n=>{_.user=n,_.selectedGroups=[],_.show=!0},Q=async()=>{var n,i;if(_.selectedGroups.length===0){y("請至少選擇一個群組","warning");return}x.addUser=!0;try{const f=Math.random().toString(36).slice(-10);(await V.post("/api/users",{username:_.user.username,full_name:_.user.full_name,email:_.user.email,department:_.user.department,is_active:!0,is_ad_user:!0,ad_guid:_.user.guid,group_ids:_.selectedGroups,password:f})).data.success&&(_.show=!1,y("AD 使用者已成功加入系統","success"))}catch(f){console.error("加入 AD 使用者失敗:",f),y(((i=(n=f.response)==null?void 0:n.data)==null?void 0:i.detail)||"加入 AD 使用者失敗","error")}finally{x.addUser=!1}},M=n=>n?n.split(" ").map(i=>i.charAt(0)).join("").toUpperCase().substr(0,2):"?",y=(n,i="success")=>{D.text=n,D.color=i,D.show=!0};return Y(()=>{B(),z()}),{adStatus:U,adConfig:e,loading:x,searchQuery:s,adUsers:G,showNoResults:L,groups:S,userDialog:_,snackbar:D,adForm:C,searchForm:k,canTest:p,canSave:N,testConnection:h,saveADConfig:j,searchAdUsers:R,selectAdUser:P,addAdUser:Q,getUserInitials:M,maxResults:F,maxResultsOptions:c}}},ee={key:1},se={class:"d-flex justify-space-between align-center mb-2"},ae={class:"text-white"},te={class:"d-flex flex-column"},le={class:"text-body-2"},oe={key:0,class:"text-body-2 mt-1"},ne={key:1,class:"text-body-2 mt-1"},re={key:2,class:"text-body-2 mt-1 text-grey-darken-1"},de={key:2,class:"text-center py-5"},ie={class:"d-flex align-center mb-3"},ue={class:"text-white"},me={class:"text-h6"},ce={class:"d-flex flex-column"},fe={class:"d-flex align-center mb-2"},_e={class:"text-body-2"},ve={key:0,class:"d-flex align-center mb-2"},ge={class:"text-body-2"},be={key:1,class:"d-flex align-center mb-2"},pe={class:"text-body-2"},ye={key:2,class:"d-flex align-center mb-2"},xe={class:"text-body-2"},ke={key:3,class:"d-flex align-start mb-2"},we={class:"text-body-2"};function De(U,e,x,s,G,L){const S=r("v-col"),_=r("v-row"),D=r("v-card-title"),C=r("v-alert"),k=r("v-text-field"),F=r("v-spacer"),c=r("v-icon"),p=r("v-btn"),N=r("v-card-actions"),B=r("v-form"),z=r("v-card-text"),h=r("v-card"),j=r("v-select"),R=r("v-divider"),P=r("v-chip"),Q=r("v-avatar"),M=r("v-list-item-title"),y=r("v-list-item-subtitle"),n=r("v-list-item"),i=r("v-list"),f=r("v-checkbox"),v=r("v-sheet"),J=r("v-dialog"),K=r("v-snackbar"),W=r("AdminLayout");return u(),A(W,null,{default:t(()=>[a(_,null,{default:t(()=>[a(S,{cols:"12"},{default:t(()=>e[12]||(e[12]=[d("h1",{class:"text-h4 mb-6"},"AD 設定",-1)])),_:1})]),_:1}),a(_,null,{default:t(()=>[a(S,{cols:"12",md:"8"},{default:t(()=>[a(h,null,{default:t(()=>[a(D,{class:"bg-primary text-white"},{default:t(()=>e[13]||(e[13]=[o(" AD 網域設定 ")])),_:1}),a(z,{class:"pt-4"},{default:t(()=>[s.adStatus.configured?(u(),A(C,{key:0,color:"success",icon:"mdi-check-circle",class:"mb-4"},{default:t(()=>e[14]||(e[14]=[o(" AD 設定已配置完成並可用 ")])),_:1})):(u(),A(C,{key:1,color:"info",icon:"mdi-information",class:"mb-4"},{default:t(()=>e[15]||(e[15]=[o(" AD 設定尚未完成配置，請填寫以下資訊 ")])),_:1})),a(B,{ref:"adForm",onSubmit:E(s.saveADConfig,["prevent"])},{default:t(()=>[a(k,{modelValue:s.adConfig.domain_name,"onUpdate:modelValue":e[0]||(e[0]=l=>s.adConfig.domain_name=l),label:"網域名稱",hint:"例如：hanlin.com.tw",variant:"outlined",rules:[l=>!!l||"請輸入網域名稱"],class:"mb-3"},null,8,["modelValue","rules"]),a(k,{modelValue:s.adConfig.primary_dc,"onUpdate:modelValue":e[1]||(e[1]=l=>s.adConfig.primary_dc=l),label:"主要網域控制器",hint:"例如：192.168.1.6",variant:"outlined",rules:[l=>!!l||"請輸入主要網域控制器IP"],class:"mb-3"},null,8,["modelValue","rules"]),a(k,{modelValue:s.adConfig.secondary_dcs,"onUpdate:modelValue":e[2]||(e[2]=l=>s.adConfig.secondary_dcs=l),label:"次要網域控制器",hint:"例如：192.168.1.5,192.168.5.5 (多個以逗號分隔)",variant:"outlined",class:"mb-3"},null,8,["modelValue"]),a(k,{modelValue:s.adConfig.bind_username,"onUpdate:modelValue":e[3]||(e[3]=l=>s.adConfig.bind_username=l),label:"綁定查詢帳號",hint:"用於LDAP查詢的帳號，例如：ldap_query",variant:"outlined",rules:[l=>!!l||"請輸入綁定查詢帳號"],class:"mb-3"},null,8,["modelValue","rules"]),a(k,{modelValue:s.adConfig.bind_password,"onUpdate:modelValue":e[4]||(e[4]=l=>s.adConfig.bind_password=l),label:"綁定查詢密碼",hint:"用於LDAP查詢的密碼",type:"password",variant:"outlined",rules:[l=>!!l||"請輸入綁定查詢密碼"],class:"mb-3"},null,8,["modelValue","rules"]),a(N,null,{default:t(()=>[a(F),a(p,{color:"secondary",variant:"outlined",class:"mr-2",onClick:s.testConnection,loading:s.loading.test,disabled:!s.canTest},{default:t(()=>[a(c,{start:""},{default:t(()=>e[16]||(e[16]=[o("mdi-check-network")])),_:1}),e[17]||(e[17]=o(" 測試連線 "))]),_:1},8,["onClick","loading","disabled"]),a(p,{color:"primary",type:"submit",loading:s.loading.save,disabled:!s.canSave},{default:t(()=>[a(c,{start:""},{default:t(()=>e[18]||(e[18]=[o("mdi-content-save")])),_:1}),e[19]||(e[19]=o(" 儲存設定 "))]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1}),a(S,{cols:"12",md:"4"},{default:t(()=>[a(h,null,{default:t(()=>[a(D,{class:"bg-primary text-white"},{default:t(()=>e[20]||(e[20]=[o(" AD 使用者搜尋 ")])),_:1}),a(z,{class:"pt-4"},{default:t(()=>[s.adStatus.configured?g("",!0):(u(),A(C,{key:0,color:"warning",icon:"mdi-alert",class:"mb-4"},{default:t(()=>e[21]||(e[21]=[o(" 請先完成 AD 設定後再使用此功能 ")])),_:1})),a(B,{ref:"searchForm",onSubmit:E(s.searchAdUsers,["prevent"])},{default:t(()=>[a(k,{modelValue:s.searchQuery,"onUpdate:modelValue":e[5]||(e[5]=l=>s.searchQuery=l),label:"搜尋 AD 使用者",hint:"輸入姓名、帳號或信箱關鍵字",variant:"outlined","append-inner-icon":"mdi-magnify",clearable:"",rules:[l=>!!l||"請輸入搜尋關鍵字"],class:"mb-3",disabled:!s.adStatus.configured,"onClick:appendInner":s.searchAdUsers},null,8,["modelValue","rules","disabled","onClick:appendInner"]),a(j,{modelValue:s.maxResults,"onUpdate:modelValue":e[6]||(e[6]=l=>s.maxResults=l),label:"搜尋結果數量",items:s.maxResultsOptions,variant:"outlined",class:"mb-3",disabled:!s.adStatus.configured},null,8,["modelValue","items","disabled"]),a(p,{color:"primary",block:"",loading:s.loading.search,disabled:!s.adStatus.configured||!s.searchQuery,class:"mb-3",onClick:s.searchAdUsers},{default:t(()=>[a(c,{start:""},{default:t(()=>e[22]||(e[22]=[o("mdi-account-search")])),_:1}),e[23]||(e[23]=o(" 搜尋 "))]),_:1},8,["loading","disabled","onClick"])]),_:1},8,["onSubmit"]),a(R,{class:"my-4"}),s.adUsers.length>0?(u(),b("div",ee,[d("div",se,[e[24]||(e[24]=d("h3",{class:"text-subtitle-1"},"搜尋結果",-1)),a(P,{size:"small",color:"primary",variant:"outlined"},{default:t(()=>[o(m(s.adUsers.length)+" / "+m(s.maxResults)+" 筆 ",1)]),_:1})]),s.adUsers.length===s.maxResults?(u(),A(C,{key:0,color:"info",variant:"tonal",class:"mb-3",density:"compact"},{default:t(()=>[a(c,{start:""},{default:t(()=>e[25]||(e[25]=[o("mdi-information")])),_:1}),e[26]||(e[26]=o(" 已達到搜尋結果上限，可能還有更多符合條件的使用者 "))]),_:1})):g("",!0),a(i,{lines:"three"},{default:t(()=>[(u(!0),b(O,null,H(s.adUsers,(l,I)=>(u(),b(O,{key:l.guid||`user-${I}`},[a(n,{class:"mb-2"},{prepend:t(()=>[a(Q,{color:"info",class:"mr-3"},{default:t(()=>[d("span",ae,m(s.getUserInitials(l.display_name||l.full_name)),1)]),_:2},1024)]),append:t(()=>[a(p,{size:"small",icon:"mdi-account-plus",variant:"text",color:"primary",onClick:Ae=>s.selectAdUser(l),title:"加入系統使用者"},null,8,["onClick"])]),default:t(()=>[a(M,{class:"font-weight-medium"},{default:t(()=>[o(m(l.display_name||l.full_name)+" ",1),l.title?(u(),A(P,{key:0,size:"x-small",color:"blue-grey",class:"ml-2"},{default:t(()=>[o(m(l.title),1)]),_:2},1024)):g("",!0)]),_:2},1024),a(y,{class:"mt-1"},{default:t(()=>[d("div",te,[d("span",le,[a(c,{size:"small",class:"mr-1"},{default:t(()=>e[27]||(e[27]=[o("mdi-account")])),_:1}),o(" "+m(l.username),1)]),l.email?(u(),b("span",oe,[a(c,{size:"small",class:"mr-1"},{default:t(()=>e[28]||(e[28]=[o("mdi-email")])),_:1}),o(" "+m(l.email),1)])):g("",!0),l.department?(u(),b("span",ne,[a(c,{size:"small",class:"mr-1"},{default:t(()=>e[29]||(e[29]=[o("mdi-domain")])),_:1}),o(" "+m(l.department),1)])):g("",!0),l.description?(u(),b("span",re,[a(c,{size:"small",class:"mr-1"},{default:t(()=>e[30]||(e[30]=[o("mdi-information")])),_:1}),o(" "+m(l.description),1)])):g("",!0)])]),_:2},1024)]),_:2},1024),I<s.adUsers.length-1?(u(),A(R,{key:`divider-${I}`})):g("",!0)],64))),128))]),_:1})])):s.showNoResults?(u(),b("div",de,[a(c,{size:"48",color:"grey-lighten-1"},{default:t(()=>e[31]||(e[31]=[o("mdi-account-off")])),_:1}),e[32]||(e[32]=d("p",{class:"text-body-1 mt-2 text-grey"},"沒有找到符合條件的 AD 使用者",-1))])):g("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),a(J,{modelValue:s.userDialog.show,"onUpdate:modelValue":e[9]||(e[9]=l=>s.userDialog.show=l),"max-width":"600px"},{default:t(()=>[a(h,null,{default:t(()=>[a(D,{class:"bg-primary text-white"},{default:t(()=>e[33]||(e[33]=[o(" 加入 AD 使用者 ")])),_:1}),a(z,{class:"pt-4"},{default:t(()=>[a(h,{variant:"outlined",class:"mb-4"},{default:t(()=>[a(z,null,{default:t(()=>[d("div",ie,[a(Q,{color:"info",class:"mr-3"},{default:t(()=>[d("span",ue,m(s.getUserInitials(s.userDialog.user.display_name||s.userDialog.user.full_name)),1)]),_:1}),d("div",null,[d("h3",me,m(s.userDialog.user.display_name||s.userDialog.user.full_name),1),e[34]||(e[34]=d("p",{class:"text-body-2 text-grey-darken-1 mb-0"},"即將加入系統使用者",-1))])]),a(R,{class:"mb-3"}),d("div",ce,[d("div",fe,[a(c,{size:"small",class:"mr-2"},{default:t(()=>e[35]||(e[35]=[o("mdi-account")])),_:1}),d("span",_e,[e[36]||(e[36]=d("strong",null,"帳號：",-1)),o(m(s.userDialog.user.username),1)])]),s.userDialog.user.email?(u(),b("div",ve,[a(c,{size:"small",class:"mr-2"},{default:t(()=>e[37]||(e[37]=[o("mdi-email")])),_:1}),d("span",ge,[e[38]||(e[38]=d("strong",null,"信箱：",-1)),o(m(s.userDialog.user.email),1)])])):g("",!0),s.userDialog.user.department?(u(),b("div",be,[a(c,{size:"small",class:"mr-2"},{default:t(()=>e[39]||(e[39]=[o("mdi-domain")])),_:1}),d("span",pe,[e[40]||(e[40]=d("strong",null,"部門：",-1)),o(m(s.userDialog.user.department),1)])])):g("",!0),s.userDialog.user.title?(u(),b("div",ye,[a(c,{size:"small",class:"mr-2"},{default:t(()=>e[41]||(e[41]=[o("mdi-badge-account")])),_:1}),d("span",xe,[e[42]||(e[42]=d("strong",null,"職稱：",-1)),o(m(s.userDialog.user.title),1)])])):g("",!0),s.userDialog.user.description?(u(),b("div",ke,[a(c,{size:"small",class:"mr-2 mt-1"},{default:t(()=>e[43]||(e[43]=[o("mdi-information")])),_:1}),d("span",we,[e[44]||(e[44]=d("strong",null,"描述：",-1)),o(m(s.userDialog.user.description),1)])])):g("",!0)])]),_:1})]),_:1}),a(R,{class:"mb-4"}),a(v,{"max-height":"250px",class:"overflow-y-auto mb-4"},{default:t(()=>[e[45]||(e[45]=d("h3",{class:"text-subtitle-1 mb-2"},"選擇群組",-1)),(u(!0),b(O,null,H(s.groups,l=>(u(),A(f,{key:l.id,modelValue:s.userDialog.selectedGroups,"onUpdate:modelValue":e[7]||(e[7]=I=>s.userDialog.selectedGroups=I),label:l.name,value:l.id,"hide-details":"",class:"mb-2"},null,8,["modelValue","label","value"]))),128))]),_:1})]),_:1}),a(N,null,{default:t(()=>[a(F),a(p,{color:"grey",variant:"text",onClick:e[8]||(e[8]=l=>s.userDialog.show=!1)},{default:t(()=>e[46]||(e[46]=[o(" 取消 ")])),_:1}),a(p,{color:"primary",onClick:s.addAdUser,loading:s.loading.addUser},{default:t(()=>e[47]||(e[47]=[o(" 加入使用者 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(K,{modelValue:s.snackbar.show,"onUpdate:modelValue":e[11]||(e[11]=l=>s.snackbar.show=l),color:s.snackbar.color,timeout:3e3},{actions:t(()=>[a(p,{variant:"text",onClick:e[10]||(e[10]=l=>s.snackbar.show=!1)},{default:t(()=>e[48]||(e[48]=[o(" 關閉 ")])),_:1})]),default:t(()=>[o(m(s.snackbar.text)+" ",1)]),_:1},8,["modelValue","color"])]),_:1})}const Ue=X($,[["render",De]]);export{Ue as default};
