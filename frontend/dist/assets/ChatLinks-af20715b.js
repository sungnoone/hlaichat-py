import{_ as $,r as C,j as x,o as ee,a as s,b as k,c as V,w as a,d as S,e as l,f as L,g as i,l as le,t as U,h as F,i as Y,F as Z,p as E,m as oe,n as te}from"./index-a1ba2a77.js";import{A as ae}from"./AdminLayout-918e61dc.js";import{c as ne}from"./api-26b8bab1.js";const ie={name:"ChatLinks",components:{AdminLayout:ae},setup(){const H=C([]),e=C([]),B=C([]),t=C(!1),K=C(!1),R=C(""),u=x({type:""}),_=x({page:1,totalPages:1,totalItems:0,itemsPerPage:10}),W=C([{title:"連結名稱",key:"name"},{title:"描述",key:"description"},{title:"類型",key:"link_type"},{title:"可使用群組",key:"groups"},{title:"建立日期",key:"created_at"},{title:"操作",key:"actions",sortable:!1,align:"end"}]),d=x({show:!1,isEdit:!1,loading:!1,data:{id:null,name:"",description:"",link_type:"n8n_host_chat",url:"",embed_code:"",webhook_url:"",credential_id:null,group_ids:[]}}),p=x({show:!1,linkId:null,linkName:"",selectedGroups:[],loading:!1}),f=x({show:!1,code:""}),c=x({show:!1,id:null,name:"",loading:!1}),D=x({show:!1,text:"",color:"success"}),g=C(null),v=n=>new Date(n).toLocaleDateString("zh-TW"),b=n=>{switch(n){case"n8n_host_chat":return"primary";case"n8n_embedded_chat":return"secondary";case"n8n_webhook":return"success";case"flowise_chat":return"info";default:return"grey"}},z=n=>{switch(n){case"n8n_host_chat":return"n8n Host Chat";case"n8n_embedded_chat":return"n8n Embedded Chat";case"n8n_webhook":return"n8n Webhook";case"flowise_chat":return"Flowise Chat";default:return n}},h=async(n=_.page)=>{t.value=!0,_.page=n;try{const r={page:_.page,page_size:_.itemsPerPage,name:R.value||void 0};u.type&&(r.link_type=u.type);const o=await S.get("/api/chat-links/admin",{params:r});o.data.success&&(H.value=o.data.items,_.totalPages=o.data.total_pages,_.totalItems=o.data.total)}catch(r){console.error("獲取聊天連結失敗:",r),w("獲取聊天連結失敗","error")}finally{t.value=!1}},j=async()=>{try{const n=await S.get("/api/groups");n.data.success&&(e.value=n.data.items)}catch(n){console.error("獲取群組失敗:",n)}},M=async()=>{try{const n=await ne.getAllCredentials();B.value=n}catch(n){console.error("獲取憑證失敗:",n)}},q=n=>{window.open(n,"_blank")},y=n=>{f.code=n.embed_code,f.show=!0},G=()=>{navigator.clipboard.writeText(f.code).then(()=>{K.value=!0}).catch(n=>{console.error("複製失敗:",n)})},N=n=>{window.open(`/chat?link_id=${n.id}`,"_blank")},T=()=>{d.isEdit=!1,d.data={id:null,name:"",description:"",link_type:"n8n_host_chat",url:"",embed_code:"",webhook_url:"",credential_id:null,group_ids:[]},d.show=!0},J=n=>{d.isEdit=!0,d.data={id:n.id,name:n.name,description:n.description||"",link_type:n.link_type,url:n.url||"",embed_code:n.embed_code||"",webhook_url:n.webhook_url||"",credential_id:n.credential_id||null,group_ids:n.groups?n.groups.map(r=>r.id):[]},d.show=!0},O=n=>{p.linkId=n.id,p.linkName=n.name,p.selectedGroups=n.groups?n.groups.map(r=>r.id):[],p.show=!0},P=n=>{c.id=n.id,c.name=n.name,c.show=!0},I=async()=>{var r,o;const{valid:n}=await g.value.validate();if(n){d.loading=!0;try{let m;const A={name:d.data.name,description:d.data.description,link_type:d.data.link_type,group_ids:d.data.group_ids};d.data.link_type==="n8n_host_chat"?A.url=d.data.url:d.data.link_type==="n8n_embedded_chat"?A.embed_code=d.data.embed_code:d.data.link_type==="n8n_webhook"&&(A.webhook_url=d.data.webhook_url,A.credential_id=d.data.credential_id),d.isEdit?m=await S.put(`/api/chat-links/${d.data.id}`,A):m=await S.post("/api/chat-links",A),m.data.success&&(d.show=!1,h(),w(d.isEdit?"聊天連結更新成功":"聊天連結建立成功"))}catch(m){console.error("儲存聊天連結失敗:",m),w(((o=(r=m.response)==null?void 0:r.data)==null?void 0:o.detail)||"儲存聊天連結失敗","error")}finally{d.loading=!1}}},Q=async()=>{var n,r;p.loading=!0;try{(await S.put(`/api/chat-links/${p.linkId}`,{group_ids:p.selectedGroups})).data.success&&(p.show=!1,h(),w("可使用群組更新成功"))}catch(o){console.error("更新可使用群組失敗:",o),w(((r=(n=o.response)==null?void 0:n.data)==null?void 0:r.detail)||"更新可使用群組失敗","error")}finally{p.loading=!1}},X=async()=>{var n,r;c.loading=!0;try{(await S.delete(`/api/chat-links/${c.id}`)).data.success&&(c.show=!1,h(),w("聊天連結已刪除"))}catch(o){console.error("刪除聊天連結失敗:",o),w(((r=(n=o.response)==null?void 0:n.data)==null?void 0:r.detail)||"刪除聊天連結失敗","error")}finally{c.loading=!1}},w=(n,r="success")=>{D.text=n,D.color=r,D.show=!0};return ee(()=>{h(),j(),M()}),{chatLinks:H,groups:e,credentials:B,loading:t,copySuccess:K,search:R,filter:u,pagination:_,headers:W,linkDialog:d,groupsDialog:p,embedDialog:f,deleteDialog:c,snackbar:D,linkForm:g,formatDate:v,getLinkTypeColor:b,getLinkTypeLabel:z,fetchChatLinks:h,openLink:q,viewEmbedCode:y,copyEmbedCode:G,openChatInterface:N,openCreateDialog:T,openEditDialog:J,openGroupsDialog:O,confirmDelete:P,saveChatLink:I,updateChatLinkGroups:Q,deleteChatLink:X}}},de={class:"d-flex align-center justify-space-between mb-6"},se={key:0,class:"text-grey"},re={class:"d-flex justify-center pt-4 pb-3"},ue={key:2},me={class:"mb-4"};function ce(H,e,B,t,K,R){const u=s("v-btn"),_=s("v-col"),W=s("v-row"),d=s("v-text-field"),p=s("v-select"),f=s("v-card-text"),c=s("v-card"),D=s("v-chip"),g=s("v-icon"),v=s("v-list-item-title"),b=s("v-list-item"),z=s("v-divider"),h=s("v-list"),j=s("v-menu"),M=s("v-data-table"),q=s("v-pagination"),y=s("v-spacer"),G=s("v-card-title"),N=s("v-textarea"),T=s("v-radio"),J=s("v-radio-group"),O=s("v-form"),P=s("v-card-actions"),I=s("v-dialog"),Q=s("v-checkbox"),X=s("v-sheet"),w=s("v-alert"),n=s("v-snackbar"),r=s("AdminLayout");return k(),V(r,null,{default:a(()=>[l(W,null,{default:a(()=>[l(_,{cols:"12"},{default:a(()=>[L("div",de,[e[28]||(e[28]=L("h1",{class:"text-h4"},"聊天連結管理",-1)),l(u,{color:"primary","prepend-icon":"mdi-link-plus",onClick:t.openCreateDialog},{default:a(()=>e[27]||(e[27]=[i(" 新增連結 ")])),_:1},8,["onClick"])])]),_:1})]),_:1}),l(c,{class:"mb-4"},{default:a(()=>[l(f,null,{default:a(()=>[l(W,null,{default:a(()=>[l(_,{cols:"12",md:"6"},{default:a(()=>[l(d,{modelValue:t.search,"onUpdate:modelValue":e[0]||(e[0]=o=>t.search=o),label:"搜尋聊天連結","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",class:"mb-3 mb-md-0",onKeyup:le(t.fetchChatLinks,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),l(_,{cols:"6",md:"4"},{default:a(()=>[l(p,{modelValue:t.filter.type,"onUpdate:modelValue":[e[1]||(e[1]=o=>t.filter.type=o),t.fetchChatLinks],label:"類型",items:[{value:"",title:"所有類型"},{value:"n8n_host_chat",title:"n8n Host Chat"},{value:"n8n_embedded_chat",title:"n8n Embedded Chat"},{value:"n8n_webhook",title:"n8n Webhook"}],"item-title":"title","item-value":"value",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(_,{cols:"6",md:"2"},{default:a(()=>[l(u,{color:"primary",variant:"tonal",block:"",onClick:t.fetchChatLinks},{default:a(()=>e[29]||(e[29]=[i(" 搜尋 ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1}),l(c,null,{default:a(()=>[l(M,{headers:t.headers,items:t.chatLinks,loading:t.loading,"items-per-page":10,class:"elevation-1"},{"item.link_type":a(({item:o})=>[l(D,{color:t.getLinkTypeColor(o.link_type),size:"small"},{default:a(()=>[i(U(t.getLinkTypeLabel(o.link_type)),1)]),_:2},1032,["color"])]),"item.groups":a(({item:o})=>[(k(!0),F(Z,null,Y(o.groups,m=>(k(),V(D,{key:m.id,color:"info",size:"small",class:"mr-1 mb-1",variant:"outlined"},{default:a(()=>[i(U(m.name),1)]),_:2},1024))),128)),!o.groups||o.groups.length===0?(k(),F("span",se," 無群組 ")):E("",!0)]),"item.created_at":a(({item:o})=>[i(U(t.formatDate(o.created_at)),1)]),"item.actions":a(({item:o})=>[l(j,null,{activator:a(({props:m})=>[l(u,oe(m,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:a(()=>[l(h,null,{default:a(()=>[l(b,{onClick:m=>t.openEditDialog(o)},{default:a(()=>[l(v,null,{default:a(()=>[l(g,{start:""},{default:a(()=>e[30]||(e[30]=[i("mdi-pencil")])),_:1}),e[31]||(e[31]=i(" 編輯 "))]),_:1})]),_:2},1032,["onClick"]),l(b,{onClick:m=>t.openGroupsDialog(o)},{default:a(()=>[l(v,null,{default:a(()=>[l(g,{start:""},{default:a(()=>e[32]||(e[32]=[i("mdi-account-group")])),_:1}),e[33]||(e[33]=i(" 管理群組 "))]),_:1})]),_:2},1032,["onClick"]),o.link_type==="n8n_host_chat"?(k(),V(b,{key:0,onClick:m=>t.openLink(o.url)},{default:a(()=>[l(v,null,{default:a(()=>[l(g,{start:""},{default:a(()=>e[34]||(e[34]=[i("mdi-open-in-new")])),_:1}),e[35]||(e[35]=i(" 開啟連結 "))]),_:1})]),_:2},1032,["onClick"])):E("",!0),o.link_type==="n8n_embedded_chat"?(k(),V(b,{key:1,onClick:m=>t.viewEmbedCode(o)},{default:a(()=>[l(v,null,{default:a(()=>[l(g,{start:""},{default:a(()=>e[36]||(e[36]=[i("mdi-code-tags")])),_:1}),e[37]||(e[37]=i(" 查看嵌入代碼 "))]),_:1})]),_:2},1032,["onClick"])):E("",!0),o.link_type==="n8n_webhook"?(k(),V(b,{key:2,onClick:m=>t.openChatInterface(o)},{default:a(()=>[l(v,null,{default:a(()=>[l(g,{start:""},{default:a(()=>e[38]||(e[38]=[i("mdi-chat")])),_:1}),e[39]||(e[39]=i(" 開啟聊天介面 "))]),_:1})]),_:2},1032,["onClick"])):E("",!0),l(z),l(b,{onClick:m=>t.confirmDelete(o),class:"text-error"},{default:a(()=>[l(v,null,{default:a(()=>[l(g,{start:""},{default:a(()=>e[40]||(e[40]=[i("mdi-delete")])),_:1}),e[41]||(e[41]=i(" 刪除 "))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:1},8,["headers","items","loading"]),L("div",re,[l(q,{modelValue:t.pagination.page,"onUpdate:modelValue":[e[2]||(e[2]=o=>t.pagination.page=o),t.fetchChatLinks],length:t.pagination.totalPages,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])]),_:1}),l(I,{modelValue:t.linkDialog.show,"onUpdate:modelValue":e[13]||(e[13]=o=>t.linkDialog.show=o),"max-width":"700px"},{default:a(()=>[l(c,null,{default:a(()=>[l(G,{class:"bg-primary text-white"},{default:a(()=>[i(U(t.linkDialog.isEdit?"編輯聊天連結":"新增聊天連結")+" ",1),l(y),l(u,{icon:"mdi-close",variant:"text",color:"white",onClick:e[3]||(e[3]=o=>t.linkDialog.show=!1)})]),_:1}),l(f,{class:"pt-4"},{default:a(()=>[l(O,{ref:"linkForm",onSubmit:te(t.saveChatLink,["prevent"])},{default:a(()=>[l(d,{modelValue:t.linkDialog.data.name,"onUpdate:modelValue":e[4]||(e[4]=o=>t.linkDialog.data.name=o),label:"連結名稱",rules:[o=>!!o||"請輸入連結名稱"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"]),l(N,{modelValue:t.linkDialog.data.description,"onUpdate:modelValue":e[5]||(e[5]=o=>t.linkDialog.data.description=o),label:"連結描述",variant:"outlined","auto-grow":"",class:"mb-3"},null,8,["modelValue"]),l(J,{modelValue:t.linkDialog.data.link_type,"onUpdate:modelValue":e[6]||(e[6]=o=>t.linkDialog.data.link_type=o),label:"連結類型",class:"mb-3"},{default:a(()=>[l(T,{value:"n8n_host_chat",label:"n8n Host Chat (完整網址)"}),l(T,{value:"n8n_embedded_chat",label:"n8n Embedded Chat (嵌入代碼)"}),l(T,{value:"n8n_webhook",label:"n8n Webhook (API 端點)"})]),_:1},8,["modelValue"]),t.linkDialog.data.link_type==="n8n_host_chat"?(k(),V(d,{key:0,modelValue:t.linkDialog.data.url,"onUpdate:modelValue":e[7]||(e[7]=o=>t.linkDialog.data.url=o),label:"n8n Host Chat URL",rules:[o=>!!o||"請輸入 n8n Host Chat URL"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"])):E("",!0),t.linkDialog.data.link_type==="n8n_embedded_chat"?(k(),V(N,{key:1,modelValue:t.linkDialog.data.embed_code,"onUpdate:modelValue":e[8]||(e[8]=o=>t.linkDialog.data.embed_code=o),label:"n8n Embedded Chat 嵌入代碼",rules:[o=>!!o||"請輸入嵌入代碼"],variant:"outlined","auto-grow":"",rows:"8",class:"mb-3"},null,8,["modelValue","rules"])):E("",!0),t.linkDialog.data.link_type==="n8n_webhook"?(k(),F("div",ue,[l(d,{modelValue:t.linkDialog.data.webhook_url,"onUpdate:modelValue":e[9]||(e[9]=o=>t.linkDialog.data.webhook_url=o),label:"n8n Webhook URL",rules:[o=>!!o||"請輸入 n8n Webhook URL"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"]),l(p,{modelValue:t.linkDialog.data.credential_id,"onUpdate:modelValue":e[10]||(e[10]=o=>t.linkDialog.data.credential_id=o),label:"選擇 API Key 憑證",items:t.credentials,"item-title":"name","item-value":"id",variant:"outlined",class:"mb-3",clearable:""},{"no-data":a(()=>[l(b,null,{default:a(()=>[l(v,null,{default:a(()=>e[42]||(e[42]=[i(" 尚無可用的憑證，請先到憑證管理新增 ")])),_:1})]),_:1})]),_:1},8,["modelValue","items"])])):E("",!0),l(z,{class:"mb-3"}),e[43]||(e[43]=L("div",{class:"text-subtitle-1 mb-2"},"可使用群組",-1)),l(p,{modelValue:t.linkDialog.data.group_ids,"onUpdate:modelValue":e[11]||(e[11]=o=>t.linkDialog.data.group_ids=o),label:"選擇可使用的群組",items:t.groups,"item-title":"name","item-value":"id",multiple:"",chips:"","closable-chips":"",variant:"outlined",class:"mb-3"},null,8,["modelValue","items"])]),_:1},8,["onSubmit"])]),_:1}),l(P,{class:"pb-4 px-4"},{default:a(()=>[l(y),l(u,{color:"error",variant:"text",onClick:e[12]||(e[12]=o=>t.linkDialog.show=!1)},{default:a(()=>e[44]||(e[44]=[i(" 取消 ")])),_:1}),l(u,{color:"primary",onClick:t.saveChatLink,loading:t.linkDialog.loading},{default:a(()=>e[45]||(e[45]=[i(" 儲存 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(I,{modelValue:t.groupsDialog.show,"onUpdate:modelValue":e[17]||(e[17]=o=>t.groupsDialog.show=o),"max-width":"600px"},{default:a(()=>[l(c,null,{default:a(()=>[l(G,{class:"bg-primary text-white"},{default:a(()=>[e[46]||(e[46]=i(" 管理可使用群組 ")),l(y),l(u,{icon:"mdi-close",variant:"text",color:"white",onClick:e[14]||(e[14]=o=>t.groupsDialog.show=!1)})]),_:1}),l(f,{class:"pt-4"},{default:a(()=>[L("p",me,"為「"+U(t.groupsDialog.linkName)+"」選擇可使用的群組：",1),l(X,{"max-height":"300px",class:"overflow-y-auto"},{default:a(()=>[(k(!0),F(Z,null,Y(t.groups,o=>(k(),V(Q,{key:o.id,modelValue:t.groupsDialog.selectedGroups,"onUpdate:modelValue":e[15]||(e[15]=m=>t.groupsDialog.selectedGroups=m),label:o.name,value:o.id,"hide-details":"",class:"mb-2"},null,8,["modelValue","label","value"]))),128))]),_:1})]),_:1}),l(P,{class:"pb-4 px-4"},{default:a(()=>[l(y),l(u,{color:"error",variant:"text",onClick:e[16]||(e[16]=o=>t.groupsDialog.show=!1)},{default:a(()=>e[47]||(e[47]=[i(" 取消 ")])),_:1}),l(u,{color:"primary",onClick:t.updateChatLinkGroups,loading:t.groupsDialog.loading},{default:a(()=>e[48]||(e[48]=[i(" 儲存群組設定 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(I,{modelValue:t.embedDialog.show,"onUpdate:modelValue":e[21]||(e[21]=o=>t.embedDialog.show=o),"max-width":"700px"},{default:a(()=>[l(c,null,{default:a(()=>[l(G,{class:"bg-primary text-white"},{default:a(()=>[e[49]||(e[49]=i(" 查看嵌入代碼 ")),l(y),l(u,{icon:"mdi-close",variant:"text",color:"white",onClick:e[18]||(e[18]=o=>t.embedDialog.show=!1)})]),_:1}),l(f,{class:"pt-4"},{default:a(()=>[l(w,{type:"info",density:"compact",class:"mb-3"},{default:a(()=>e[50]||(e[50]=[i(" 您可以複製以下代碼並嵌入到您的網頁中。 ")])),_:1}),l(N,{modelValue:t.embedDialog.code,"onUpdate:modelValue":e[19]||(e[19]=o=>t.embedDialog.code=o),readonly:"","auto-grow":"",variant:"outlined",rows:"8",label:"嵌入代碼"},null,8,["modelValue"])]),_:1}),l(P,null,{default:a(()=>[l(y),l(u,{color:"primary",variant:"text",onClick:t.copyEmbedCode},{default:a(()=>[l(g,{start:""},{default:a(()=>e[51]||(e[51]=[i("mdi-content-copy")])),_:1}),e[52]||(e[52]=i(" 複製代碼 "))]),_:1},8,["onClick"]),l(u,{color:"grey",variant:"text",onClick:e[20]||(e[20]=o=>t.embedDialog.show=!1)},{default:a(()=>e[53]||(e[53]=[i(" 關閉 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(I,{modelValue:t.deleteDialog.show,"onUpdate:modelValue":e[23]||(e[23]=o=>t.deleteDialog.show=o),"max-width":"500"},{default:a(()=>[l(c,null,{default:a(()=>[l(G,{class:"bg-error text-white"},{default:a(()=>e[54]||(e[54]=[i(" 刪除聊天連結 ")])),_:1}),l(f,{class:"pt-4"},{default:a(()=>[L("p",null,"確定要刪除聊天連結「"+U(t.deleteDialog.name)+"」嗎？",1),e[55]||(e[55]=L("p",{class:"text-caption text-grey"},"此操作無法復原。",-1))]),_:1}),l(P,null,{default:a(()=>[l(y),l(u,{color:"grey",variant:"text",onClick:e[22]||(e[22]=o=>t.deleteDialog.show=!1)},{default:a(()=>e[56]||(e[56]=[i(" 取消 ")])),_:1}),l(u,{color:"error",variant:"flat",onClick:t.deleteChatLink,loading:t.deleteDialog.loading},{default:a(()=>e[57]||(e[57]=[i(" 刪除 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(n,{modelValue:t.copySuccess,"onUpdate:modelValue":e[24]||(e[24]=o=>t.copySuccess=o),timeout:2e3,color:"success"},{default:a(()=>e[58]||(e[58]=[i(" 已複製到剪貼簿 ")])),_:1},8,["modelValue"]),l(n,{modelValue:t.snackbar.show,"onUpdate:modelValue":e[26]||(e[26]=o=>t.snackbar.show=o),color:t.snackbar.color,timeout:3e3},{actions:a(()=>[l(u,{variant:"text",onClick:e[25]||(e[25]=o=>t.snackbar.show=!1)},{default:a(()=>e[59]||(e[59]=[i(" 關閉 ")])),_:1})]),default:a(()=>[i(U(t.snackbar.text)+" ",1)]),_:1},8,["modelValue","color"])]),_:1})}const fe=$(ie,[["render",ce]]);export{fe as default};
