import{_ as O,r as I,j as N,k as Q,o as X,a as u,b as V,c as G,w as s,d as v,e as l,f as k,g as d,p as P,h as K,t as w,m as Y,n as Z}from"./index-a1ba2a77.js";import{A as $}from"./AdminLayout-918e61dc.js";const ee={name:"Groups",components:{AdminLayout:$},setup(){const S=I([]),a=I([]),B=I(!1),t=I(""),U=N({page:1,totalPages:1,totalItems:0,itemsPerPage:10}),J=I([{title:"群組名稱",key:"name"},{title:"描述",key:"description"},{title:"權限",key:"permissions"},{title:"成員",key:"users"},{title:"建立日期",key:"created_at"},{title:"操作",key:"actions",sortable:!1,align:"end"}]),c=I([{title:"使用者名稱",key:"username"},{title:"姓名",key:"full_name"},{title:"狀態",key:"is_active"},{title:"類型",key:"is_ad_user"},{title:"群組成員",key:"is_member",align:"center"}]),m=N({show:!1,isEdit:!1,loading:!1,data:{id:null,name:"",description:"",can_login:!0,can_manage_platform:!1,can_use_chat_links:!0}}),r=N({show:!1,loading:!1,batchLoading:!1,groupId:null,groupName:"",search:"",memberIds:[],filter:"all"}),_=N({show:!1,id:null,name:"",loading:!1}),y=N({show:!1,text:"",color:"success"}),D=I(null),g=Q(()=>{let o=[...a.value];if(r.search){const n=r.search.toLowerCase();o=o.filter(e=>e.username.toLowerCase().includes(n)||e.full_name.toLowerCase().includes(n))}return r.filter==="members"?o=o.filter(n=>n.is_member):r.filter==="nonmembers"&&(o=o.filter(n=>!n.is_member)),o}),h=()=>g.value.filter(o=>!o.is_member).length,z=()=>g.value.filter(o=>o.is_member).length,L=async()=>{r.batchLoading=!0;try{const o=g.value.filter(e=>!e.is_member);for(const e of o)e.isUpdating=!0,e.is_member=!0;const n=o.map(e=>e.id);for(const e of n){const C=a.value.find(f=>f.id===e).groups.map(f=>f.id);await v.put(`/api/users/${e}`,{group_ids:[...C,r.groupId]})}for(const e of o)e.isUpdating=!1;r.memberIds=[...r.memberIds,...n],b(),p("批量加入成員成功")}catch(o){console.error("批量加入成員失敗:",o),p("批量加入成員失敗","error"),g.value.forEach(n=>{n.isUpdating=!1,n.is_member=r.memberIds.includes(n.id)})}finally{r.batchLoading=!1}},j=async()=>{r.batchLoading=!0;try{const o=g.value.filter(e=>e.is_member);for(const e of o)e.isUpdating=!0,e.is_member=!1;const n=o.map(e=>e.id);for(const e of n){const C=a.value.find(f=>f.id===e).groups.filter(f=>f.id!==r.groupId).map(f=>f.id);await v.put(`/api/users/${e}`,{group_ids:C})}for(const e of o)e.isUpdating=!1;r.memberIds=r.memberIds.filter(e=>!n.includes(e)),b(),p("批量移除成員成功")}catch(o){console.error("批量移除成員失敗:",o),p("批量移除成員失敗","error"),g.value.forEach(n=>{n.isUpdating=!1,n.is_member=r.memberIds.includes(n.id)})}finally{r.batchLoading=!1}},q=async()=>{if(r.groupId){r.loading=!0,r.memberIds=[];try{a.value.length===0?await H():await H();const o=S.value.find(i=>i.id===r.groupId);if(!o){console.error("無法在前端找到群組:",r.groupId),p("無法找到群組資料","error"),r.loading=!1;return}const n=(o==null?void 0:o.users)||[];r.memberIds=n.map(i=>i.id),a.value=a.value.map(i=>({...i,is_member:r.memberIds.includes(i.id),isUpdating:!1}));const e=a.value.filter(i=>i.is_member);if(n.length>0&&e.length===0){console.warn("警告: 群組有成員但標記後沒有成員，可能是資料不一致");try{const i=await v.get(`/api/groups/${r.groupId}`);if(i.data.success){const C=i.data.data;C.users&&C.users.length>0&&(r.memberIds=C.users.map(f=>f.id),a.value=a.value.map(f=>({...f,is_member:r.memberIds.includes(f.id),isUpdating:!1})))}}catch(i){console.error("獲取群組詳情失敗:",i)}}}catch(o){console.error("獲取群組成員失敗:",o),p("獲取群組成員失敗","error")}finally{r.loading=!1}}},T=o=>new Date(o).toLocaleDateString("zh-TW"),b=async()=>{B.value=!0;try{const o=await v.get("/api/groups",{params:{page:U.page,page_size:U.itemsPerPage,name:t.value}});o.data.success&&(S.value=o.data.items,U.totalPages=o.data.total_pages,U.totalItems=o.data.total)}catch(o){console.error("獲取群組失敗:",o),p("獲取群組失敗","error")}finally{B.value=!1}},H=async()=>{try{const o=await v.get("/api/users",{params:{page:1,page_size:1e3}});if(o.data.success){if(a.value=o.data.items,o.data.total>o.data.page_size){const n=o.data.total_pages;for(let e=2;e<=n;e++)try{const i=await v.get("/api/users",{params:{page:e,page_size:1e3}});i.data.success&&(a.value=[...a.value,...i.data.items])}catch(i){console.error(`獲取第 ${e} 頁使用者失敗:`,i)}}}else console.error("獲取使用者列表失敗:",o.data)}catch(o){console.error("獲取使用者失敗:",o),o.response?(console.error("錯誤回應:",o.response.data),console.error("錯誤詳情:",o.response.data),console.error("錯誤狀態:",o.response.status),console.error("錯誤標頭:",o.response.headers)):o.request?console.error("請求未收到回應:",o.request):console.error("錯誤訊息:",o.message)}},x=()=>{m.isEdit=!1,m.data={id:null,name:"",description:"",can_login:!0,can_manage_platform:!1,can_use_chat_links:!0},m.show=!0},M=o=>{m.isEdit=!0,m.data={id:o.id,name:o.name,description:o.description||"",can_login:o.can_login,can_manage_platform:o.can_manage_platform,can_use_chat_links:o.can_use_chat_links},m.show=!0},R=async o=>{r.groupId=o.id,r.groupName=o.name,r.search="",r.filter="all",r.loading=!0,r.show=!0;try{await q()}catch(n){console.error("開啟管理成員對話框失敗:",n)}},E=o=>{_.id=o.id,_.name=o.name,_.show=!0},W=async()=>{var n,e;const{valid:o}=await D.value.validate();if(o){m.loading=!0;try{let i;m.isEdit?i=await v.put(`/api/groups/${m.data.id}`,{name:m.data.name,description:m.data.description,can_login:m.data.can_login,can_manage_platform:m.data.can_manage_platform,can_use_chat_links:m.data.can_use_chat_links}):i=await v.post("/api/groups",{name:m.data.name,description:m.data.description,can_login:m.data.can_login,can_manage_platform:m.data.can_manage_platform,can_use_chat_links:m.data.can_use_chat_links}),i.data.success&&(m.show=!1,b(),p(m.isEdit?"群組更新成功":"群組建立成功"))}catch(i){console.error("儲存群組失敗:",i),p(((e=(n=i.response)==null?void 0:n.data)==null?void 0:e.detail)||"儲存群組失敗","error")}finally{m.loading=!1}}},A=async o=>{o.isUpdating=!0;try{const n=!o.is_member;console.log("切換使用者群組成員身份前:",{userId:o.id,username:o.username,currentMembership:o.is_member,updatedMembership:n,currentGroups:o.groups.map(e=>({id:e.id,name:e.name}))}),n?(await v.put(`/api/users/${o.id}`,{group_ids:[...o.groups.map(e=>e.id),r.groupId]}),r.memberIds.includes(o.id)||r.memberIds.push(o.id)):(await v.put(`/api/users/${o.id}`,{group_ids:o.groups.filter(e=>e.id!==r.groupId).map(e=>e.id)}),r.memberIds=r.memberIds.filter(e=>e!==o.id)),o.is_member=n,console.log("切換使用者群組成員身份後:",{userId:o.id,username:o.username,newMembership:o.is_member,memberIds:r.memberIds}),b()}catch(n){console.error("更新使用者群組失敗:",n),p("更新使用者群組失敗","error"),o.is_member=r.memberIds.includes(o.id)}finally{o.isUpdating=!1}},F=async()=>{var o,n;_.loading=!0;try{(await v.delete(`/api/groups/${_.id}`)).data.success&&(_.show=!1,b(),p("群組已刪除"))}catch(e){console.error("刪除群組失敗:",e),p(((n=(o=e.response)==null?void 0:o.data)==null?void 0:n.detail)||"刪除群組失敗","error")}finally{_.loading=!1}},p=(o,n="success")=>{y.text=o,y.color=n,y.show=!0};return X(()=>{b()}),{groups:S,loading:B,search:t,pagination:U,headers:J,userHeaders:c,groupDialog:m,usersDialog:r,deleteDialog:_,snackbar:y,groupForm:D,displayedUsers:g,getFilteredNonMemberCount:h,getFilteredMemberCount:z,addAllFilteredUsers:L,removeAllFilteredUsers:j,fetchGroupUsers:q,formatDate:T,fetchGroups:b,openCreateDialog:x,openEditDialog:M,openUsersDialog:R,confirmDelete:E,saveGroup:W,toggleUserMembership:A,deleteGroup:F}}},ae={class:"d-flex align-center justify-space-between mb-6"},oe={key:0},le={key:1,class:"text-grey"},te={class:"d-flex justify-center pt-4 pb-3"},se={class:"mb-4"},re={class:"d-flex align-center mb-3"},ne={class:"d-flex mb-4 align-center"},ie={class:"text-center"};function de(S,a,B,t,U,J){const c=u("v-btn"),m=u("v-col"),r=u("v-row"),_=u("v-text-field"),y=u("v-card-text"),D=u("v-card"),g=u("v-chip"),h=u("v-icon"),z=u("v-list-item-title"),L=u("v-list-item"),j=u("v-divider"),q=u("v-list"),T=u("v-menu"),b=u("v-data-table"),H=u("v-pagination"),x=u("v-spacer"),M=u("v-card-title"),R=u("v-textarea"),E=u("v-switch"),W=u("v-form"),A=u("v-card-actions"),F=u("v-dialog"),p=u("v-btn-toggle"),o=u("v-snackbar"),n=u("AdminLayout");return V(),G(n,null,{default:s(()=>[l(r,null,{default:s(()=>[l(m,{cols:"12"},{default:s(()=>[k("div",ae,[a[20]||(a[20]=k("h1",{class:"text-h4"},"群組管理",-1)),l(c,{color:"primary","prepend-icon":"mdi-account-group-outline",onClick:t.openCreateDialog},{default:s(()=>a[19]||(a[19]=[d(" 新增群組 ")])),_:1},8,["onClick"])])]),_:1})]),_:1}),l(r,null,{default:s(()=>[l(m,{cols:"12"},{default:s(()=>[l(D,{class:"mb-4"},{default:s(()=>[l(y,null,{default:s(()=>[l(_,{modelValue:t.search,"onUpdate:modelValue":a[0]||(a[0]=e=>t.search=e),label:"搜尋群組名稱","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",clearable:"",onInput:t.fetchGroups,"onClick:clear":t.fetchGroups},null,8,["modelValue","onInput","onClick:clear"])]),_:1})]),_:1})]),_:1})]),_:1}),l(r,null,{default:s(()=>[l(m,{cols:"12"},{default:s(()=>[l(D,null,{default:s(()=>[l(b,{headers:t.headers,items:t.groups,loading:t.loading,"items-per-page":10,class:"elevation-1"},{"item.permissions":s(({item:e})=>[e.can_login?(V(),G(g,{key:0,size:"small",color:"success",class:"mr-1 mb-1"},{default:s(()=>a[21]||(a[21]=[d(" 可登入 ")])),_:1})):P("",!0),e.can_manage_platform?(V(),G(g,{key:1,size:"small",color:"error",class:"mr-1 mb-1"},{default:s(()=>a[22]||(a[22]=[d(" 可管理 ")])),_:1})):P("",!0),e.can_use_chat_links?(V(),G(g,{key:2,size:"small",color:"info",class:"mr-1 mb-1"},{default:s(()=>a[23]||(a[23]=[d(" 可使用聊天 ")])),_:1})):P("",!0)]),"item.users":s(({item:e})=>[e.users&&e.users.length>0?(V(),K("span",oe,w(e.users.length)+" 名成員 ",1)):(V(),K("span",le," 無成員 "))]),"item.created_at":s(({item:e})=>[d(w(t.formatDate(e.created_at)),1)]),"item.actions":s(({item:e})=>[l(T,null,{activator:s(({props:i})=>[l(c,Y(i,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:s(()=>[l(q,null,{default:s(()=>[l(L,{onClick:i=>t.openEditDialog(e)},{default:s(()=>[l(z,null,{default:s(()=>[l(h,{start:""},{default:s(()=>a[24]||(a[24]=[d("mdi-pencil")])),_:1}),a[25]||(a[25]=d(" 編輯 "))]),_:1})]),_:2},1032,["onClick"]),l(L,{onClick:i=>t.openUsersDialog(e)},{default:s(()=>[l(z,null,{default:s(()=>[l(h,{start:""},{default:s(()=>a[26]||(a[26]=[d("mdi-account-multiple")])),_:1}),a[27]||(a[27]=d(" 管理成員 "))]),_:1})]),_:2},1032,["onClick"]),l(j),l(L,{onClick:i=>t.confirmDelete(e),class:"text-error"},{default:s(()=>[l(z,null,{default:s(()=>[l(h,{start:""},{default:s(()=>a[28]||(a[28]=[d("mdi-delete")])),_:1}),a[29]||(a[29]=d(" 刪除 "))]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:1},8,["headers","items","loading"]),k("div",te,[l(H,{modelValue:t.pagination.page,"onUpdate:modelValue":[a[1]||(a[1]=e=>t.pagination.page=e),t.fetchGroups],length:t.pagination.totalPages,"total-visible":7},null,8,["modelValue","length","onUpdate:modelValue"])])]),_:1})]),_:1})]),_:1}),l(F,{modelValue:t.groupDialog.show,"onUpdate:modelValue":a[9]||(a[9]=e=>t.groupDialog.show=e),"max-width":"600px"},{default:s(()=>[l(D,null,{default:s(()=>[l(M,{class:"bg-primary text-white"},{default:s(()=>[d(w(t.groupDialog.isEdit?"編輯群組":"新增群組")+" ",1),l(x),l(c,{icon:"mdi-close",variant:"text",color:"white",onClick:a[2]||(a[2]=e=>t.groupDialog.show=!1)})]),_:1}),l(y,{class:"pt-4"},{default:s(()=>[l(W,{ref:"groupForm",onSubmit:Z(t.saveGroup,["prevent"])},{default:s(()=>[l(_,{modelValue:t.groupDialog.data.name,"onUpdate:modelValue":a[3]||(a[3]=e=>t.groupDialog.data.name=e),label:"群組名稱",rules:[e=>!!e||"請輸入群組名稱"],variant:"outlined",class:"mb-3"},null,8,["modelValue","rules"]),l(R,{modelValue:t.groupDialog.data.description,"onUpdate:modelValue":a[4]||(a[4]=e=>t.groupDialog.data.description=e),label:"群組描述",variant:"outlined","auto-grow":"",class:"mb-3"},null,8,["modelValue"]),l(j,{class:"mb-3"}),a[30]||(a[30]=k("div",{class:"text-subtitle-1 mb-2"},"群組權限",-1)),l(E,{modelValue:t.groupDialog.data.can_login,"onUpdate:modelValue":a[5]||(a[5]=e=>t.groupDialog.data.can_login=e),label:"允許登入平台",color:"success","hide-details":"",class:"mb-3"},null,8,["modelValue"]),l(E,{modelValue:t.groupDialog.data.can_manage_platform,"onUpdate:modelValue":a[6]||(a[6]=e=>t.groupDialog.data.can_manage_platform=e),label:"允許管理平台 (管理員權限)",color:"error","hide-details":"",class:"mb-3"},null,8,["modelValue"]),l(E,{modelValue:t.groupDialog.data.can_use_chat_links,"onUpdate:modelValue":a[7]||(a[7]=e=>t.groupDialog.data.can_use_chat_links=e),label:"允許使用聊天連結",color:"info","hide-details":"",class:"mb-4"},null,8,["modelValue"])]),_:1},8,["onSubmit"])]),_:1}),l(A,{class:"pb-4 px-4"},{default:s(()=>[l(x),l(c,{color:"error",variant:"text",onClick:a[8]||(a[8]=e=>t.groupDialog.show=!1)},{default:s(()=>a[31]||(a[31]=[d(" 取消 ")])),_:1}),l(c,{color:"primary",onClick:t.saveGroup,loading:t.groupDialog.loading},{default:s(()=>a[32]||(a[32]=[d(" 儲存 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(F,{modelValue:t.usersDialog.show,"onUpdate:modelValue":a[14]||(a[14]=e=>t.usersDialog.show=e),"max-width":"800px"},{default:s(()=>[l(D,null,{default:s(()=>[l(M,{class:"bg-primary text-white"},{default:s(()=>[a[33]||(a[33]=d(" 管理群組成員 ")),l(x),l(c,{icon:"mdi-close",variant:"text",color:"white",onClick:a[10]||(a[10]=e=>t.usersDialog.show=!1)})]),_:1}),l(y,{class:"pt-4"},{default:s(()=>[k("p",se,"「"+w(t.usersDialog.groupName)+"」群組的成員：",1),k("div",re,[l(_,{modelValue:t.usersDialog.search,"onUpdate:modelValue":a[11]||(a[11]=e=>t.usersDialog.search=e),label:"搜尋使用者","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",class:"mr-3","hide-details":"",clearable:"",style:{"max-width":"300px"}},null,8,["modelValue"]),l(g,{color:"primary",size:"small",variant:"outlined"},{default:s(()=>[d(" 成員數量："+w(t.usersDialog.memberIds.length),1)]),_:1})]),k("div",ne,[l(p,{modelValue:t.usersDialog.filter,"onUpdate:modelValue":a[12]||(a[12]=e=>t.usersDialog.filter=e),density:"comfortable",color:"primary"},{default:s(()=>[l(c,{value:"all"},{default:s(()=>a[34]||(a[34]=[d("全部")])),_:1}),l(c,{value:"members"},{default:s(()=>a[35]||(a[35]=[d("成員")])),_:1}),l(c,{value:"nonmembers"},{default:s(()=>a[36]||(a[36]=[d("非成員")])),_:1})]),_:1},8,["modelValue"]),l(x),t.usersDialog.filter==="nonmembers"&&t.getFilteredNonMemberCount()>0?(V(),G(c,{key:0,color:"success",size:"small",class:"ml-2","prepend-icon":"mdi-account-multiple-plus",onClick:t.addAllFilteredUsers,loading:t.usersDialog.batchLoading},{default:s(()=>a[37]||(a[37]=[d(" 加入所有篩選使用者 ")])),_:1},8,["onClick","loading"])):P("",!0),t.usersDialog.filter==="members"&&t.getFilteredMemberCount()>0?(V(),G(c,{key:1,color:"error",size:"small",class:"ml-2","prepend-icon":"mdi-account-multiple-remove",onClick:t.removeAllFilteredUsers,loading:t.usersDialog.batchLoading},{default:s(()=>a[38]||(a[38]=[d(" 移除所有篩選使用者 ")])),_:1},8,["onClick","loading"])):P("",!0)]),l(b,{headers:t.userHeaders,items:t.displayedUsers,loading:t.usersDialog.loading,"items-per-page":10,class:"elevation-1"},{"item.is_active":s(({item:e})=>[l(g,{color:e.is_active?"success":"error",size:"small"},{default:s(()=>[d(w(e.is_active?"啟用":"停用"),1)]),_:2},1032,["color"])]),"item.is_ad_user":s(({item:e})=>[l(g,{color:e.is_ad_user?"info":"secondary",size:"small"},{default:s(()=>[d(w(e.is_ad_user?"AD 帳號":"平台帳號"),1)]),_:2},1032,["color"])]),"item.is_member":s(({item:e})=>[k("div",ie,[l(c,{color:e.is_member?"error":"success",icon:e.is_member?"mdi-account-remove":"mdi-account-plus",size:"small",variant:"text",disabled:t.usersDialog.loading,onClick:i=>t.toggleUserMembership(e),loading:e.isUpdating},null,8,["color","icon","disabled","onClick","loading"])])]),_:1},8,["headers","items","loading"])]),_:1}),l(A,{class:"pb-4 px-4"},{default:s(()=>[l(c,{color:"secondary",variant:"outlined",onClick:t.fetchGroupUsers},{default:s(()=>[l(h,{start:""},{default:s(()=>a[39]||(a[39]=[d("mdi-refresh")])),_:1}),a[40]||(a[40]=d(" 重新整理 "))]),_:1},8,["onClick"]),l(x),l(c,{color:"primary",onClick:a[13]||(a[13]=e=>t.usersDialog.show=!1)},{default:s(()=>a[41]||(a[41]=[d(" 完成 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(F,{modelValue:t.deleteDialog.show,"onUpdate:modelValue":a[16]||(a[16]=e=>t.deleteDialog.show=e),"max-width":"500"},{default:s(()=>[l(D,null,{default:s(()=>[l(M,{class:"bg-error text-white"},{default:s(()=>a[42]||(a[42]=[d(" 刪除群組 ")])),_:1}),l(y,{class:"pt-4"},{default:s(()=>[k("p",null,"確定要刪除群組「"+w(t.deleteDialog.name)+"」嗎？",1),a[43]||(a[43]=k("p",{class:"text-caption text-grey"},"此操作會解除所有使用者與此群組的關聯，並且無法復原。",-1))]),_:1}),l(A,null,{default:s(()=>[l(x),l(c,{color:"grey",variant:"text",onClick:a[15]||(a[15]=e=>t.deleteDialog.show=!1)},{default:s(()=>a[44]||(a[44]=[d(" 取消 ")])),_:1}),l(c,{color:"error",variant:"flat",onClick:t.deleteGroup,loading:t.deleteDialog.loading},{default:s(()=>a[45]||(a[45]=[d(" 刪除 ")])),_:1},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(o,{modelValue:t.snackbar.show,"onUpdate:modelValue":a[18]||(a[18]=e=>t.snackbar.show=e),color:t.snackbar.color,timeout:3e3},{actions:s(()=>[l(c,{variant:"text",onClick:a[17]||(a[17]=e=>t.snackbar.show=!1)},{default:s(()=>a[46]||(a[46]=[d(" 關閉 ")])),_:1})]),default:s(()=>[d(w(t.snackbar.text)+" ",1)]),_:1},8,["modelValue","color"])]),_:1})}const ce=O(ee,[["render",de]]);export{ce as default};
