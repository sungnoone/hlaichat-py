# 修改歷程

本文件記錄 HLAIChat 管理平台的所有重要變更。

## [未發布]

### 新增

- 2025-05-27: 修復 n8n webhook 回應解析問題
  - 修正後端 `chat_service.py` 中的 webhook 回應處理邏輯
  - 支援多種回應格式：優先解析 `output` 欄位，其次為 `message`、`text`、`content` 欄位
  - 新增詳細的 webhook 回應日誌記錄，包含原始回應內容、狀態碼和標頭資訊
  - 改善 JSON 解析錯誤處理，當無法解析 JSON 時將原始文字作為回應內容
  - 新增完整的錯誤堆疊追蹤，便於除錯和問題診斷
  - **問題解決**：聊天介面現在能正確顯示 n8n "Respond to Webhook" 節點的回應內容

- 2025-05-27: 聊天逾時設定優化
  - 將所有聊天相關的逾時參數移至 `.env` 檔案統一管理
  - 新增後端逾時參數：`CHAT_WEBHOOK_TIMEOUT`、`CHAT_REQUEST_TIMEOUT`、`CHAT_CONNECTION_TIMEOUT`
  - 新增前端逾時參數：`VITE_CHAT_TIMEOUT`
  - 修改後端 `chat_service.py` 使用環境變數中的逾時設定，取代硬編碼的 30 秒逾時
  - 修改前端 `ChatInterface.vue` 使用環境變數中的逾時設定
  - 建立詳細的逾時設定說明文件 `CHAT_TIMEOUT_CONFIGURATION.md`
  - 更新 `env-template.txt` 包含新的逾時參數
  - 確保 n8n workflow 有足夠時間處理複雜的 AI 請求

- 2025-05-27: 修復 .env 檔案中文亂碼問題
  - 使用 UTF-8 編碼重新建立 `.env` 檔案，解決中文註解顯示亂碼問題
  - 確保檔案包含完整的環境變數參數，包括新增的聊天逾時設定
  - 同步更新 `env-template.txt` 檔案格式，保持範本與實際檔案一致
  - 改進 README.md 中的編碼問題說明，提供更詳細的解決方案

- 2025-05-24: 完善 webhook trigger workflow 仿 ChatGPT 聊天介面設計
  - 新增聊天會話和訊息資料模型 (ChatSession, ChatMessage)
  - 建立聊天相關的 Pydantic 模型和 API 路由
  - 實作聊天服務類別，支援會話管理和 webhook 整合
  - 建立仿 ChatGPT 的前端聊天介面組件
  - 支援多會話管理、訊息歷程記錄和即時對話
  - 整合 n8n webhook 參數傳遞規範
  - 新增聊天功能到使用者導航選單
  - 更新資料庫遷移腳本，支援聊天相關表格建立

- 2025-05-24: 聊天連結類型重構，支援未來 Flowise 整合
  - **重要變更**: 重新設計聊天連結類型命名系統，避免日後混淆
    - `host_chat` → `n8n_host_chat`
    - `embedded_chat` → `n8n_embedded_chat`
    - `webhook` → `n8n_webhook`
    - 預留 `flowise_chat` 類型供未來擴展
  - 建立並執行資料庫遷移腳本 `migrate_chat_link_types.py`
  - 成功更新 2 個現有聊天連結的類型
  - 更新前後端所有相關的類型檢查和顯示邏輯
  - 建立測試腳本 `test_chat_link_types.py` 驗證系統正確性
  - 更新測試功能文件，新增類型系統測試指引
  - 建立詳細的遷移說明文件 `CHAT_LINK_TYPES_MIGRATION.md`
  - 確保類型系統具備良好的擴展性和向後相容性

- 初始專案架構設定
- 資料庫模型定義
- API 路由實作
  - 使用者管理 API
  - 群組管理 API
  - 聊天連結管理 API
  - AD 設定 API
  - 操作紀錄 API
  - 憑證管理 API (2025-05-23)
- 認證與授權機制
- AD 網域整合
- 操作紀錄功能
- 憑證管理功能 (2025-05-23)
  - 後端憑證管理 API，包含 CRUD 操作
  - 前端憑證管理介面，支援新增、編輯、刪除憑證
  - API Key 顯示/隱藏和複製功能
  - 憑證與聊天連結的關聯管理
  - 完整的操作日誌記錄
- 前端介面開發完成
  - 登入頁面
  - 管理員儀表板
  - 使用者管理頁面
  - 群組管理頁面
  - 聊天連結管理頁面
  - AD 設定頁面
  - 操作紀錄頁面
  - 個人設定頁面
  - 一般使用者儀表板
  - 一般使用者個人資料頁面
  - 一般使用者使用紀錄頁面
  - 憑證管理頁面 (2025-05-23)
- 前後端整合測試完成
- 從原型設計中複製 logo 到正式前端
- 新增網站圖示 (favicon) 系列檔案
  - favicon.ico
  - apple-touch-icon.png
  - favicon-16x16.png
  - favicon-32x32.png
  - android-chrome-192x192.png
  - android-chrome-512x512.png
- 新增 site.webmanifest 檔案，提供 PWA 支援
- 新增 index.html 檔案，包含所有必要的圖示連結
- 2025-05-19: 優化使用者管理頁面中的群組管理功能
  - 新增搜尋功能，便於在多個群組中查找特定群組
  - 改進群組選擇界面，顯示群組權限資訊
  - 新增已選擇群組的視覺摘要
  - 新增清除所有選擇的功能
- 2025-05-19: 優化群組管理頁面中的成員管理功能
  - 新增篩選功能，可快速查看所有用戶、成員或非成員
  - 新增批量加入和移除成員的功能
  - 改進成員切換的視覺體驗，使用直觀的按鈕替代複選框
  - 新增加載狀態顯示，提供更好的用戶反饋
  - 新增重新整理功能，可以重新獲取最新的用戶列表

### 修正

- 2025-05-26: 專案清理和冗餘檔案移除
  - 移除所有 Python 編譯快取檔案 (__pycache__ 目錄和 .pyc 檔案)
  - 移除重複的遷移腳本 `backend/migrate_chat_link_types.py`（保留根目錄的最新版本）
  - 移除重複的開發指引檔案 `.clinerules/hlaichat-py.md`（保留 `.cursor/rules/hlaichat-py.mdc`）
  - 移除前端重複的 README 檔案 `frontend/README.md`（保留根目錄的完整版本）
  - 移除 `.gitignore` 檔案，避免妨礙開發中的讀寫動作
  - 保留除錯用的 console.log 語句以利日後除錯
  - 確保專案結構簡潔，移除冗餘檔案但保持功能完整性
- 2025-05-26: 修復聊天連結管理中憑證選擇功能
  - 修正前端 API 服務中的憑證路徑，將 `/api/credentials/all` 改為 `/api/credentials/simple`
  - 修正聊天連結管理頁面中的憑證載入邏輯，使用正確的 API 服務方法
  - 確保新增 webhook 類型聊天連結時能正確顯示和選擇預設的憑證
  - 改善前端錯誤處理，移除不必要的回應格式檢查
  - **功能驗證完成**：新增 webhook 類型連結已可選到預先設定的憑證
- 2025-05-23: 修復憑證服務類別的方法調用問題
  - 將 CredentialService 中的靜態方法改為實例方法，支援依賴注入模式
  - 修正服務類別的初始化方式，接受資料庫 session 參數
  - 統一錯誤處理方式，使用 ValueError 替代 HTTPException
  - 確保憑證管理 API 能正常返回資料
- 2025-05-23: 修復資料庫結構不一致問題
  - 建立資料庫遷移腳本 migrate_db.py，自動檢查並新增缺少的欄位
  - 新增 chat_links 表的 webhook_url 和 credential_id 欄位
  - 新增 credentials 表的外鍵約束
  - 修復前端 Dashboard 頁面因資料庫欄位缺失導致的錯誤
- 2025-05-23: 修復前端依賴問題
  - 安裝缺少的 lodash-es 套件，解決 Credentials.vue 中 debounce 函數的導入錯誤
  - 確保前端開發服務器能正常啟動
- 2025-05-23: 修復憑證管理功能的導入錯誤
  - 修正 credential_routes.py 中的 require_admin 導入錯誤，改為使用 get_current_admin_user_dependency
  - 移除不存在的 LogService 依賴，改為直接使用 OperationLog 模型記錄日誌
  - 確保憑證管理 API 能正常運行並與其他模組保持一致
- 2025-05-21: 修復 AD 帳號登入功能無法被點擊使用的問題
  - 移除 Login.vue 中 AD 標籤的 disabled 屬性，使 AD 標籤始終可點擊
  - 修正 onMounted 函數中獲取 AD 設定狀態的程式碼，確保正確處理 API 回應
  - 確保 AD 登入功能不受 AD 設定狀態的影響，提高使用者體驗
- 2025-05-21: 專案程式碼清理
  - 移除所有 __pycache__ 目錄和編譯檔案，減少專案體積
  - 為空的 services/__init__.py 添加模組說明註釋，提高程式碼可讀性
  - 保留前端原型設計及介面，以備日後參考
- 2025-05-20: 修復群組成員管理功能中的 422 錯誤問題
  - 修正後端 API 參數限制，將 `/api/users` 端點的 `page_size` 參數上限從 100 調整為 1000
  - 修正前端獲取使用者的方式，使用正確的分頁參數
  - 增加分頁處理，支援獲取超過單頁限制的使用者
  - 增加詳細的錯誤處理和日誌輸出
- 2025-05-20: 增強群組成員管理功能的穩定性和可靠性
  - 修改 `fetchGroupUsers` 函數，增加錯誤處理和更詳細的日誌
  - 新增資料一致性檢查，當發現群組有成員但顯示為空時，嘗試直接從 API 獲取群組詳情
  - 重置成員 ID 列表，確保每次打開對話框時都是最新資料
  - 增加診斷功能，顯示資料處理的每個步驟
- 2025-05-19: 改進使用者管理介面中的群組選擇功能，現在可更清楚顯示每個群組的權限資訊
- 2025-05-19: 改進群組管理介面中的成員管理功能，優化使用者體驗和效能
- 2025-05-18: 升級功能圖示，使用更具代表性的圖示並優化展示效果，使側邊欄收合時清晰顯示圖示
- 2025-05-18: 修正側邊欄收合後功能圖示不顯示的問題，移除 v-list-item 的 prepend-icon 屬性，改用 v-slot:prepend 顯示圖示
- 2025-05-17: 修復後端啟動時的驗證錯誤，在 Settings.Config 中設定 extra = "ignore" 允許額外的環境變數
- 2025-05-17: 整合多個 .env 檔案為一個，修改 run.py 和 config.py 以指向根目錄的 .env 檔案
- 2025-05-17: 整合環境變數設定到單一 .env 檔案，修改 vite.config.js 使前端從根目錄讀取環境變數
- 2025-05-16: 整合環境變數設定，建立 setup_env.ps1 腳本自動生成 .env 檔案，確保所有設定集中管理
- 2025-05-15: 修改前端程式碼，使其從環境變數讀取 API 基礎 URL，避免硬編碼
- 2025-05-15: 修正前端操作紀錄頁面，使其與後端 API 的新資料結構一致
- 2025-05-15: 修正操作紀錄 API 的資料格式問題，解決 ResponseValidationError
- 2025-05-15: 修正用戶操作紀錄 API 的資料結構，確保與其他操作紀錄 API 一致
- 2025-05-15: 修正前端 UserHistory.vue 中的代碼，使其正確處理後端回傳的操作紀錄資料
- 2025-05-15: 修正 .env 檔案的編碼問題，確保正確讀取環境變數
- 2025-05-15: 更新後端 CORS 設定，允許更多前端來源 (localhost 和 127.0.0.1 的不同端口)
- 2025-05-15: 改進前端 token 處理邏輯，增加 token 過期檢查
- 2025-05-15: 增強前端錯誤處理和日誌記錄，提供更詳細的錯誤訊息
- 2025-05-06: 將 python-ldap 改為 ldap3，解決 Windows 環境下安裝需要 Microsoft Visual C++ 14.0 或更高版本的問題
- 2025-05-06: 添加 pydantic-settings 套件，解決 BaseSettings 已經從 pydantic 移動到 pydantic-settings 套件的問題
- 2025-05-06: 添加 pytz 套件，解決時區處理相關的依賴問題
- 2025-05-06: 在 Settings 類別中添加缺少的環境變數欄位，解決 pydantic 驗證錯誤
- 2025-05-06: 修改資料庫連線字串處理邏輯，將 postgres:// 協議改為 postgresql://，以符合 SQLAlchemy 的要求
- 2025-05-07: 將所有 schema 文件中的 `orm_mode = True` 替換為 `from_attributes = True`，以適應 Pydantic v2 的變化
- 2025-05-07: 修改 `security.py` 中的 `verify_token` 函數，使其返回一個簡單的字典而不是嘗試創建一個不完整的 `UserInDB` 對象，解決 `/api/auth/login` 端點的錯誤
- 2025-05-14: 在前端 main.js 中添加 axios 全局配置，設置基本 URL 和請求/響應攔截器
- 2025-05-14: 修改 Login.vue 組件，使用全局註冊的 axios 進行 API 調用
- 2025-05-14: 創建環境變數文件 .env，配置必要的後端參數

### 已完成

- 後端 API 開發 (2025-05-07)
  - 使用者管理 API
  - 群組管理 API
  - 聊天連結管理 API
  - AD 設定 API
  - 操作紀錄 API
  - 認證與授權機制
- 前端介面開發 (2025-05-14)
  - 管理員介面
  - 使用者介面
  - 前後端整合
- 錯誤修復與優化 (2025-05-15)
  - 環境變數編碼問題
  - CORS 設定優化
  - Token 處理邏輯改進
  - 錯誤處理增強
  - 操作紀錄 API 修正
  - 前端操作紀錄頁面修正
- 環境變數整合 (2025-05-17)
  - 整合多個 .env 檔案為單一檔案
  - 優化前端和後端的環境變數讀取方式
  - 修復環境變數驗證錯誤
- 使用者和群組管理功能優化 (2025-05-19)
  - 使用者管理介面中的群組選擇功能優化
  - 群組管理介面中的成員管理功能優化
  - 批量操作功能實作
  - 使用者體驗改進
- 群組成員管理功能修復 (2025-05-20)
  - 修復 422 錯誤問題
  - 增強功能穩定性和可靠性
  - 改進錯誤處理和診斷

### 待開發

- 資料庫遷移腳本
- 單元測試
- 部署文件
- 效能優化
- 安全性增強
  - 密碼加密存儲
  - CORS 設定優化
  - 輸入驗證強化

## [Unreleased]

### 修復
- 2025-05-20: 修復群組成員管理功能中的 422 錯誤問題，修正後端API參數限制和前端獲取使用者的方式
- 2025-05-20: 增強群組成員管理功能的穩定性和可靠性，增加錯誤處理和診斷功能
- 修復AD使用者搜尋功能中處理objectGUID時出現的「str' object has no attribute 'hex'」錯誤
- 增強AD搜尋功能，現在可以處理不同類型的GUID格式
- 修復AD使用者加入平台群組時出現「Field required: password」錯誤，為AD使用者添加隨機生成的密碼欄位值

### 新增

- 2025-05-19: 優化使用者管理頁面中的群組管理功能，新增搜尋、清除等便利功能
- 2025-05-19: 優化群組管理頁面中的成員管理功能，新增篩選、批量操作等功能
- 2025-05-18: 在 main.js 中引入 Material Design Icons (MDI) 的 CSS 文件，修正不顯示圖示的問題
- 2025-05-18: 升級功能圖示，使用更具代表性的圖示並優化展示效果
- 2025-05-18: 修正側邊欄收合後功能圖示不顯示的問題
- 2025-05-17: 修復後端啟動時的驗證錯誤
- 2025-05-17: 整合多個 .env 檔案為一個
- 2025-05-17: 整合環境變數設定到單一 .env 檔案
- 2025-05-16: 整合環境變數設定，建立自動生成腳本
- 2025-05-15: 修改前端程式碼，使用環境變數
- 2025-05-15: 修正前端操作紀錄頁面
- 2025-05-15: 修正操作紀錄 API
- 2025-05-15: 修正用戶操作紀錄 API
- 2025-05-15: 修正 UserHistory.vue
- 2025-05-15: 修正 .env 檔案編碼
- 2025-05-15: 更新後端 CORS 設定
- 2025-05-15: 改進前端 token 處理
- 2025-05-15: 增強前端錯誤處理
- 2025-05-06: 將 python-ldap 改為 ldap3
- 2025-05-06: 添加 pydantic-settings 套件
- 2025-05-06: 添加 pytz 套件
- 2025-05-06: 添加缺少的環境變數欄位
- 2025-05-06: 修改資料庫連線字串處理邏輯
- 2025-05-07: 更新 schema 文件適應 Pydantic v2
- 2025-05-07: 修改 security.py
- 2025-05-14: 添加 axios 全局配置
- 2025-05-14: 修改 Login.vue 組件
- 2025-05-14: 創建環境變數文件 .env
